<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#E8612C">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="EnCollector">
  <title>English Collector</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* ==================== Variables ==================== */
    :root {
      --cream: #FFFDF7; --card-yellow: #FFF9E6; --card-yellow-hover: #FFF5D6;
      --warm-gray: #F5F3EF; --text-primary: #2D2A26; --text-secondary: #6B665C;
      --text-muted: #A8A299; --accent: #E8612C; --accent-light: #FFEEE8;
      --success: #4CAF50; --error: #E53935; --border: rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--cream); -webkit-font-smoothing: antialiased;
      min-height: 100vh; overflow-x: hidden; line-height: 1.5;
    }
    .font-serif { font-family: 'Playfair Display', Georgia, serif; }

    /* ==================== Ambient ==================== */
    .ambient-glow { position: fixed; top: -20%; left: -10%; width: 60%; height: 50%; background: radial-gradient(ellipse at center, rgba(255,180,150,0.25) 0%, rgba(255,200,180,0.15) 30%, transparent 70%); pointer-events: none; z-index: 0; }
    .ambient-glow-2 { position: fixed; bottom: -10%; right: -10%; width: 50%; height: 40%; background: radial-gradient(ellipse at center, rgba(200,220,255,0.2) 0%, transparent 70%); pointer-events: none; z-index: 0; }

    /* ==================== Header ==================== */
    .header { position: sticky; top: 0; z-index: 40; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); background: linear-gradient(to bottom, var(--cream) 80%, transparent); }
    .header-inner { display: flex; align-items: center; gap: 12px; max-width: 1200px; margin: 0 auto; }
    .menu-btn { padding: 8px; margin-left: -8px; background: none; border: none; cursor: pointer; color: var(--text-secondary); border-radius: 8px; }
    .menu-btn:hover { background: var(--warm-gray); }
    .search-box { flex: 1; max-width: 400px; display: flex; align-items: center; padding: 10px 16px; background: white; border: 1px solid var(--border); border-radius: 10px; }
    .search-box input { flex: 1; border: none; background: transparent; font-size: 14px; color: var(--text-primary); outline: none; }
    .search-box input::placeholder { color: var(--text-muted); }
    .add-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--accent); border: none; border-radius: 10px; color: white; cursor: pointer; box-shadow: 0 2px 8px rgba(232,97,44,0.3); }
    .add-btn:hover { background: #D55525; }

    /* ==================== Bottom Nav ==================== */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; background: rgba(255,253,247,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--border); padding: 4px 0; padding-bottom: max(4px, env(safe-area-inset-bottom)); }
    .nav-items { display: flex; justify-content: space-around; max-width: 500px; margin: 0 auto; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 12px; background: none; border: none; cursor: pointer; color: var(--text-muted); transition: color 0.2s; }
    .nav-item.active { color: var(--accent); }
    .nav-item:hover { color: var(--text-secondary); }
    .nav-item svg { width: 22px; height: 22px; }
    .nav-item span { font-size: 10px; font-weight: 500; }

    /* ==================== Tab Panels ==================== */
    .tab-panel { position: relative; z-index: 10; padding: 8px 16px 140px; max-width: 1200px; margin: 0 auto; display: none; }
    .tab-panel.active { display: block; }

    /* ==================== Cards & Masonry ==================== */
    .masonry { column-count: 1; column-gap: 12px; }
    @media (min-width: 500px) { .masonry { column-count: 2; } }
    @media (min-width: 800px) { .masonry { column-count: 3; column-gap: 16px; } }
    @media (min-width: 1100px) { .masonry { column-count: 4; } }
    .card { background: var(--card-yellow); border-radius: 8px; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.03); cursor: pointer; padding: 16px; break-inside: avoid; margin-bottom: 12px; }
    .card:hover { background: var(--card-yellow-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .card-content { font-size: 14px; line-height: 1.6; color: var(--text-primary); display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
    .card-keywords { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05); }
    .keyword-tag { font-size: 11px; padding: 3px 8px; background: rgba(232,97,44,0.1); color: var(--accent); border-radius: 4px; }

    /* ==================== Quick Input ==================== */
    .quick-input-wrapper { position: fixed; bottom: 68px; left: 50%; transform: translateX(-50%); width: calc(100% - 32px); max-width: 500px; z-index: 30; padding-bottom: env(safe-area-inset-bottom); }
    .quick-input { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .quick-input-label { font-size: 11px; font-weight: 500; letter-spacing: 0.5px; color: var(--accent); margin-bottom: 4px; }
    .quick-input input { width: 100%; border: none; background: transparent; font-size: 14px; color: var(--text-primary); outline: none; }

    /* ==================== Empty State ==================== */
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state-icon { width: 64px; height: 64px; margin: 0 auto 16px; background: var(--warm-gray); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
    .empty-state-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--text-primary); margin-bottom: 8px; }
    .empty-state-desc { font-size: 14px; color: var(--text-muted); }

    /* ==================== Sidebar ==================== */
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 50; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .sidebar-overlay.active { opacity: 1; visibility: visible; }
    .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: var(--cream); z-index: 51; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; }
    .sidebar.active { transform: translateX(0); }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; }
    .sidebar-logo-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; }
    .sidebar-logo-text { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--text-primary); }
    .sidebar-user { margin-top: 16px; padding: 12px; background: white; border-radius: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .sidebar-user:hover { background: var(--warm-gray); }
    .sidebar-user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--warm-gray); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .sidebar-user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .sidebar-user-info { flex: 1; min-width: 0; }
    .sidebar-user-name { font-size: 13px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sidebar-user-email { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sidebar-menu { flex: 1; padding: 12px; overflow-y: auto; }
    .sidebar-menu-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
    .sidebar-menu-item:hover { background: var(--warm-gray); }
    .sidebar-menu-item svg { width: 20px; height: 20px; flex-shrink: 0; }
    .sidebar-menu-item span { font-size: 14px; }
    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
    .sync-status { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-muted); }
    .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
    .sync-dot.synced { background: var(--success); }
    .sync-dot.syncing { background: #FFC107; animation: pulse 1s infinite; }
    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; }
    .toggle-label { font-size: 13px; color: var(--text-secondary); }
    .toggle { position: relative; width: 44px; height: 24px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: #ccc; border-radius: 24px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle input:checked + .toggle-slider { background: var(--accent); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }

    /* ==================== Modals ==================== */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.15); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 50; display: none; align-items: flex-end; justify-content: center; }
    .modal-overlay.active { display: flex; }
    @media (min-width: 640px) { .modal-overlay { align-items: center; } }
    .modal-content { background: var(--cream); border-radius: 20px 20px 0 0; width: 100%; max-height: 90vh; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; }
    @media (min-width: 640px) { .modal-content { max-width: 500px; border-radius: 20px; max-height: 85vh; } }
    .modal-body { padding: 24px; }
    .modal-close { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--warm-gray); border: none; border-radius: 50%; cursor: pointer; z-index: 2; }
    .modal-close:hover { background: #E8E6E2; }

    /* ==================== Buttons ==================== */
    .btn { padding: 12px 16px; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-secondary { background: var(--warm-gray); color: var(--text-secondary); }
    .btn-secondary:hover { background: #E8E6E2; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #D55525; }
    .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; }
    .btn-small { padding: 8px 14px; font-size: 13px; border-radius: 8px; }

    /* ==================== Add Modal ==================== */
    .add-modal-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--text-primary); margin-bottom: 16px; }
    .add-modal-textarea { width: 100%; height: 120px; padding: 14px; background: white; border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; font-size: 14px; color: var(--text-primary); resize: none; outline: none; line-height: 1.6; font-family: inherit; }
    .add-modal-textarea:focus { border-color: var(--accent); }
    .add-modal-textarea::placeholder { color: var(--text-muted); }
    .add-modal-hint { display: flex; align-items: center; gap: 8px; margin-top: 12px; font-size: 12px; color: var(--text-muted); }
    .add-modal-actions { display: flex; gap: 12px; margin-top: 20px; }
    .add-modal-actions .btn { flex: 1; }

    /* ==================== Detail Modal ==================== */
    .detail-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .detail-meta { display: flex; align-items: center; gap: 8px; }
    .type-dot { width: 6px; height: 6px; border-radius: 50%; }
    .type-word { background: #E8A87C; } .type-sentence { background: #85B8A0; } .type-paragraph { background: #9B8AA6; }
    .detail-date { font-size: 12px; color: var(--text-muted); }
    .detail-content { font-size: 18px; line-height: 1.6; color: var(--text-primary); font-weight: 300; margin-bottom: 8px; }
    .detail-translation { font-size: 14px; line-height: 1.6; color: var(--text-secondary); padding-bottom: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .keywords-section { margin-bottom: 20px; }
    .keywords-title { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .keywords-title-bar { width: 3px; height: 14px; background: var(--accent); border-radius: 2px; }
    .keywords-title-text { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
    .keywords-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .keyword-btn { padding: 8px 14px; background: white; border: 1px solid rgba(0,0,0,0.08); border-radius: 8px; font-size: 13px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; }
    .keyword-btn:hover, .keyword-btn.active { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }
    .etymology-box { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .etymology-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .etymology-word { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--text-primary); }
    .speak-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--accent-light); border: none; border-radius: 50%; color: var(--accent); cursor: pointer; }
    .speak-btn:hover { background: var(--accent); color: white; }
    .etymology-phonetic { font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
    .etymology-item { font-size: 13px; margin-bottom: 8px; line-height: 1.5; }
    .etymology-label { color: var(--text-muted); }
    .etymology-value { color: var(--text-secondary); }

    /* ==================== Etymology Tab ==================== */
    .ety-search-box { display: flex; gap: 10px; margin-bottom: 20px; }
    .ety-search-input { flex: 1; padding: 14px 18px; font-size: 15px; background: white; border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); outline: none; font-family: inherit; }
    .ety-search-input:focus { border-color: var(--accent); }
    .ety-search-input::placeholder { color: var(--text-muted); }
    .ety-search-btn { padding: 14px 24px; font-size: 14px; font-weight: 600; color: white; background: var(--accent); border: none; border-radius: 12px; cursor: pointer; white-space: nowrap; }
    .ety-search-btn:hover { background: #D55525; }
    .ety-search-btn:disabled { background: var(--text-muted); }

    .ety-sub-nav { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
    .ety-sub-btn { padding: 8px 16px; font-size: 13px; font-weight: 500; background: white; border: 1px solid var(--border); border-radius: 20px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
    .ety-sub-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .ety-sub-btn:hover:not(.active) { background: var(--warm-gray); }

    /* Result card */
    .ety-result { animation: fadeIn 0.3s ease; }
    .ety-result-header { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 16px; }
    .ety-result-word { font-family: 'Playfair Display', serif; font-size: 32px; color: var(--text-primary); }
    .ety-result-phonetic { font-size: 15px; color: var(--text-muted); margin: 4px 0 8px; }
    .ety-result-meaning { font-size: 16px; color: var(--text-secondary); line-height: 1.6; }
    .ety-result-actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }

    .ety-card { background: white; border: 1px solid var(--border); border-radius: 14px; padding: 20px; margin-bottom: 14px; }
    .ety-card-title { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 14px; }
    .ety-root-item { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; padding: 10px 12px; background: var(--warm-gray); border-radius: 10px; margin-bottom: 8px; }
    .ety-root-part { padding: 4px 10px; font-size: 13px; font-weight: 700; color: var(--accent); background: var(--accent-light); border-radius: 6px; font-family: monospace; }
    .ety-root-origin { font-size: 11px; color: var(--text-muted); padding: 2px 6px; background: white; border-radius: 4px; }
    .ety-root-meaning { font-size: 13px; color: var(--text-secondary); }
    .ety-story { font-size: 14px; color: var(--text-secondary); line-height: 1.8; }
    .ety-memory-tip { padding: 12px; font-size: 13px; color: #B8860B; background: #FFF8DC; border-radius: 10px; border: 1px solid #F0E68C; margin-top: 12px; }
    .ety-example { padding: 12px 0; border-bottom: 1px solid var(--border); }
    .ety-example:last-child { border-bottom: none; }
    .ety-example-en { font-size: 14px; color: var(--text-primary); line-height: 1.5; display: flex; align-items: flex-start; gap: 8px; }
    .ety-example-cn { font-size: 13px; color: var(--text-muted); padding-left: 30px; margin-top: 4px; }
    .ety-related { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; }
    .ety-related-tag { padding: 6px 14px; font-size: 13px; color: var(--accent); background: var(--accent-light); border: 1px solid rgba(232,97,44,0.2); border-radius: 20px; cursor: pointer; transition: all 0.2s; }
    .ety-related-tag:hover { background: var(--accent); color: white; }

    /* Categories grid */
    .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .cat-card { padding: 18px 14px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: white; border-radius: 14px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s; text-align: center; }
    .cat-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .cat-icon { font-size: 32px; }
    .cat-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .cat-count { font-size: 11px; color: var(--text-muted); }

    /* Course */
    .level-tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .level-tab { padding: 10px 18px; font-size: 13px; font-weight: 500; background: white; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; color: var(--text-secondary); }
    .level-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
    .unit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
    .unit-card { background: white; border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
    .unit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .unit-number { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .unit-badge { padding: 3px 8px; font-size: 11px; font-weight: 600; color: var(--success); background: rgba(76,175,80,0.1); border-radius: 8px; }
    .unit-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
    .unit-subtitle { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; font-family: monospace; }
    .unit-stats { display: flex; gap: 14px; font-size: 12px; color: var(--text-muted); margin-bottom: 14px; }
    .unit-actions { display: flex; gap: 8px; }
    .unit-actions .btn { flex: 1; text-align: center; }

    /* Word list */
    .word-list { display: flex; flex-direction: column; gap: 6px; }
    .word-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--warm-gray); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .word-list-item:hover { background: var(--accent-light); }
    .word-list-item span:first-child { font-size: 14px; color: var(--text-primary); font-weight: 500; }
    .word-list-item span:last-child { font-size: 13px; color: var(--text-muted); }

    /* Daily article */
    .daily-article { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
    .article-badge { padding: 4px 10px; font-size: 12px; font-weight: 600; color: #B8860B; background: #FFF8DC; border-radius: 8px; display: inline-block; margin-bottom: 12px; }
    .article-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--text-primary); margin-bottom: 12px; }
    .article-content { font-size: 14px; color: var(--text-secondary); line-height: 1.8; white-space: pre-line; margin-bottom: 16px; }
    .article-roots { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .article-root-tag { padding: 5px 12px; font-size: 13px; color: var(--accent); background: var(--accent-light); border-radius: 8px; font-family: monospace; }
    .article-examples { display: flex; gap: 10px; flex-wrap: wrap; }
    .article-word-btn { padding: 10px 16px; background: var(--warm-gray); border: none; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s; }
    .article-word-btn:hover { background: var(--accent-light); }
    .article-word-text { font-size: 15px; font-weight: 600; color: var(--accent); display: block; }
    .article-word-meaning { font-size: 12px; color: var(--text-muted); display: block; margin-top: 2px; }

    /* ==================== Review Tab ==================== */
    .review-container { text-align: center; max-width: 500px; margin: 0 auto; padding-top: 20px; }
    .flashcard { perspective: 1000px; width: 100%; max-width: 360px; height: 240px; margin: 0 auto 24px; cursor: pointer; }
    .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
    .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
    .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; background: var(--card-yellow); border-radius: 16px; padding: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .flashcard-back { transform: rotateY(180deg); text-align: left; justify-content: flex-start; align-items: stretch; overflow-y: auto; }
    .flashcard-word { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--text-primary); margin-bottom: 8px; }
    .flashcard-phonetic { font-size: 15px; color: var(--text-muted); margin-bottom: 12px; }
    .flashcard-speak { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid var(--border); border-radius: 50%; color: var(--accent); cursor: pointer; font-size: 18px; }
    .flashcard-speak:hover { background: var(--accent); color: white; }
    .flashcard-back-word { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--text-primary); margin-bottom: 4px; }
    .flashcard-back-meaning { font-size: 15px; color: var(--text-primary); margin-bottom: 10px; font-weight: 500; }
    .flashcard-back-detail { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
    .flashcard-back-detail span { color: var(--text-muted); }
    .review-stats { display: flex; justify-content: space-around; padding: 14px 16px; margin: 0 16px 16px; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .review-stat-item { text-align: center; }
    .review-stat-num { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: var(--text-primary); }
    .review-stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .review-history-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 10px; margin-bottom: 8px; }
    .review-history-word { font-size: 15px; font-weight: 500; color: var(--text-primary); flex: 1; }
    .review-level-badge { font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: 500; }
    .review-level-0 { background: #f3f4f6; color: #6b7280; }
    .review-level-1 { background: #fee2e2; color: #dc2626; }
    .review-level-2 { background: #fef3c7; color: #d97706; }
    .review-level-3 { background: #dbeafe; color: #2563eb; }
    .review-level-4 { background: #d1fae5; color: #059669; }
    .review-level-5 { background: #dcfce7; color: #16a34a; }
    .review-actions { display: flex; gap: 16px; justify-content: center; }
    .review-btn { padding: 12px 28px; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; }
    .review-btn.know { background: var(--success); color: white; }
    .review-btn.dont-know { background: #FF7043; color: white; }
    .review-progress { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }
    .review-hint { font-size: 12px; color: var(--text-muted); margin-bottom: 16px; }

    /* ==================== Settings ==================== */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 24px; }
    .stat-card { background: white; border-radius: 12px; padding: 14px 10px; text-align: center; }
    .stat-value { font-family: 'Playfair Display', serif; font-size: 26px; color: var(--text-primary); }
    .stat-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    .settings-section { margin-bottom: 24px; }
    .settings-title { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .settings-card { background: white; border-radius: 12px; overflow: hidden; }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .settings-item:last-child { border-bottom: none; }
    .settings-item-label { font-size: 14px; color: var(--text-primary); }
    .settings-item-value { font-size: 13px; color: var(--text-muted); }
    .settings-input { padding: 8px 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 13px; width: 160px; text-align: right; outline: none; }
    .settings-input:focus { border-color: var(--accent); }
    .settings-select { padding: 8px 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 13px; background: white; min-width: 140px; outline: none; }

    /* ==================== Toast & Spinner ==================== */
    .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
    .spinner-dark { border-color: rgba(0,0,0,0.1); border-top-color: var(--accent); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .toast { position: fixed; top: 20px; top: max(20px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--text-primary); color: white; padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 100; transition: transform 0.3s ease; max-width: 90%; text-align: center; }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.error { background: var(--error); }
    .toast.success { background: var(--success); }
    .hide { display: none !important; }
  </style>
</head>
<body>
  <div class="ambient-glow"></div>
  <div class="ambient-glow-2"></div>
  <div id="toast" class="toast"></div>

  <!-- ==================== Sidebar ==================== -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <div class="sidebar-logo-icon">En</div>
        <div class="sidebar-logo-text">English Collector</div>
      </div>
      <div class="sidebar-user" id="sidebarUser" onclick="handleGoogleAuth()">
        <div class="sidebar-user-avatar" id="userAvatar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
        </div>
        <div class="sidebar-user-info">
          <div class="sidebar-user-name" id="userName">æœªç™»å½•</div>
          <div class="sidebar-user-email" id="userEmail">ç‚¹å‡»ç™»å½• Google åŒæ­¥</div>
        </div>
      </div>
    </div>
    <div class="sidebar-menu">
      <div class="toggle-row">
        <span class="toggle-label">è‡ªåŠ¨åŒæ­¥</span>
        <label class="toggle"><input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()"><span class="toggle-slider"></span></label>
      </div>
      <div class="sidebar-menu-item" onclick="manualSync()">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>
        <span>ç«‹å³åŒæ­¥</span>
      </div>
      <div class="sidebar-menu-item" onclick="syncFromCloud()">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z"/></svg>
        <span>ä»äº‘ç«¯æ¢å¤</span>
      </div>
    </div>
    <div class="sidebar-footer">
      <div class="sync-status"><div class="sync-dot" id="syncDot"></div><span id="syncStatusText">æœ¬åœ°å­˜å‚¨</span></div>
    </div>
  </div>

  <!-- ==================== Header ==================== -->
  <header class="header" id="mainHeader">
    <div class="header-inner">
      <button class="menu-btn" onclick="openSidebar()">
        <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
      </button>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœç´¢æ”¶è—å†…å®¹..." oninput="handleSearch()">
      </div>
      <button class="add-btn" onclick="openAddModal()">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
    </div>
  </header>

  <!-- ==================== Tab 1: Collection ==================== -->
  <div class="tab-panel active" id="tabCollection">
    <div class="masonry" id="cardGrid"></div>
    <div class="empty-state hide" id="emptyState">
      <div class="empty-state-icon">ğŸ“</div>
      <h2 class="empty-state-title">Your mind is empty</h2>
      <p class="empty-state-desc">Start collecting words and sentences</p>
    </div>
  </div>

  <!-- ==================== Tab 2: Etymology ==================== -->
  <div class="tab-panel" id="tabEtymology">
    <!-- Search -->
    <div class="ety-search-box">
      <input class="ety-search-input" id="etySearchInput" placeholder="è¾“å…¥è‹±æ–‡å•è¯ï¼Œæ¢ç´¢è¯æº..." onkeydown="if(event.key==='Enter')etySearch()">
      <button class="ety-search-btn" id="etySearchBtn" onclick="etySearch()">è§£æ</button>
    </div>
    <!-- Sub navigation -->
    <div class="ety-sub-nav">
      <button class="ety-sub-btn active" data-view="search" onclick="switchEtyView('search')">ğŸ” æœç´¢</button>
      <button class="ety-sub-btn" data-view="explore" onclick="switchEtyView('explore')">ğŸ—ºï¸ æ¢ç´¢</button>
      <button class="ety-sub-btn" data-view="course" onclick="switchEtyView('course')">ğŸ“– è¯¾ç¨‹</button>
    </div>
    <!-- Content areas -->
    <div id="etySearchView"></div>
    <div id="etyExploreView" class="hide"></div>
    <div id="etyCourseView" class="hide"></div>
  </div>

  <!-- ==================== Tab 3: Review ==================== -->
  <div class="tab-panel" id="tabReview">
    <!-- Review Stats -->
    <div class="review-stats" id="reviewStats">
      <div class="review-stat-item"><div class="review-stat-num" id="reviewDueCount" style="color:var(--accent)">0</div><div class="review-stat-label">å¾…å¤ä¹ </div></div>
      <div class="review-stat-item"><div class="review-stat-num" id="reviewNewCount" style="color:#3b82f6">0</div><div class="review-stat-label">æ–°è¯</div></div>
      <div class="review-stat-item"><div class="review-stat-num" id="reviewMasteredCount" style="color:var(--success)">0</div><div class="review-stat-label">å·²æŒæ¡</div></div>
      <div class="review-stat-item"><div class="review-stat-num" id="reviewTotalCount">0</div><div class="review-stat-label">æ€»è¯æ±‡</div></div>
    </div>
    <!-- Review Session -->
    <div class="review-container" id="reviewContent">
      <p class="review-progress" id="reviewProgress">1 / 20</p>
      <p class="review-hint">ç‚¹å‡»å¡ç‰‡ç¿»è½¬ï¼Œç‚¹å‡» ğŸ”Š å¬å‘éŸ³</p>
      <div class="flashcard" id="flashcard" onclick="flipCard()">
        <div class="flashcard-inner">
          <div class="flashcard-front">
            <div class="flashcard-word" id="flashcardWord">word</div>
            <div class="flashcard-phonetic" id="flashcardPhonetic">/wÉœËrd/</div>
            <button class="flashcard-speak" onclick="event.stopPropagation();speakWord(document.getElementById('flashcardWord').textContent)">ğŸ”Š</button>
          </div>
          <div class="flashcard-back" id="flashcardBack"></div>
        </div>
      </div>
      <div class="review-actions">
        <button class="review-btn dont-know" onclick="markCard(false)">ä¸è®¤è¯†</button>
        <button class="review-btn know" onclick="markCard(true)">è®¤è¯†</button>
      </div>
    </div>
    <!-- Session Summary -->
    <div id="reviewSummary" class="hide" style="padding:30px 20px;text-align:center;max-width:400px;margin:0 auto">
      <div style="font-size:48px;margin-bottom:12px" id="summaryEmoji">ğŸ‰</div>
      <h3 style="font-size:20px;font-weight:600;color:var(--text-primary);margin-bottom:8px" id="summaryTitle">å¤ä¹ å®Œæˆï¼</h3>
      <p style="font-size:14px;color:var(--text-secondary);margin-bottom:20px" id="summaryText"></p>
      <div style="display:flex;gap:12px;justify-content:center">
        <button class="btn btn-secondary" onclick="showReviewHistory()" style="flex:none;padding:10px 20px">æŸ¥çœ‹è®°å½•</button>
        <button class="btn btn-primary" onclick="initReview()" style="flex:none;padding:10px 20px">ç»§ç»­å¤ä¹ </button>
      </div>
    </div>
    <!-- Empty State -->
    <div id="reviewEmpty" class="hide">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ´</div>
        <h2 class="empty-state-title">æ²¡æœ‰å¯å¤ä¹ çš„å•è¯</h2>
        <p class="empty-state-desc">å…ˆå»æ”¶è—ä¸€äº›å†…å®¹æˆ–å­¦ä¹ è¯æ ¹å§</p>
      </div>
    </div>
    <!-- Review History Modal -->
    <div id="reviewHistoryPanel" class="hide" style="padding:0 16px 80px;max-width:500px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h3 style="font-size:16px;font-weight:600;color:var(--text-primary);margin:0">å¤ä¹ è®°å½•</h3>
        <button class="btn btn-secondary" onclick="closeReviewHistory()" style="padding:6px 14px;font-size:12px">è¿”å›</button>
      </div>
      <div id="reviewHistoryList"></div>
    </div>
  </div>

  <!-- ==================== Tab 4: Settings ==================== -->
  <div class="tab-panel" id="tabSettings">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">æ”¶è—</div></div>
      <div class="stat-card"><div class="stat-value" id="statWords">0</div><div class="stat-label">è¯æ±‡</div></div>
      <div class="stat-card"><div class="stat-value" id="statEtyCount">0</div><div class="stat-label">è¯æº</div></div>
      <div class="stat-card"><div class="stat-value" id="statDays">0</div><div class="stat-label">å¤©æ•°</div></div>
    </div>
    <div class="settings-section">
      <div class="settings-title">AI è®¾ç½®</div>
      <div class="settings-card">
        <div class="settings-item">
          <span class="settings-item-label">æœåŠ¡å•†</span>
          <select class="settings-select" id="apiProvider" onchange="onProviderChange()">
            <option value="gemini">Geminiï¼ˆå…è´¹ï¼‰</option>
            <option value="openrouter">OpenRouter (Claude)</option>
            <option value="deepseek">DeepSeek</option>
          </select>
        </div>
        <div class="settings-item">
          <span class="settings-item-label">æ¨¡å‹</span>
          <select class="settings-select" id="apiModel" onchange="saveSettings()"></select>
        </div>
        <div class="settings-item">
          <span class="settings-item-label">API Key</span>
          <input type="password" class="settings-input" id="apiKey" placeholder="è¾“å…¥ API Key" onchange="saveSettings()">
        </div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-title">æ•°æ®ç®¡ç†</div>
      <div class="settings-card">
        <div class="settings-item" style="cursor:pointer" onclick="exportJSON()">
          <span class="settings-item-label">å¯¼å‡ºå¤‡ä»½ (JSON)</span>
          <span class="settings-item-value">â†“</span>
        </div>
        <div class="settings-item" style="cursor:pointer" onclick="document.getElementById('importFile').click()">
          <span class="settings-item-label">å¯¼å…¥å¤‡ä»½</span>
          <span class="settings-item-value">â†‘</span>
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
        </div>
        <div class="settings-item" style="cursor:pointer" onclick="exportAnki()">
          <span class="settings-item-label">å¯¼å‡ºåˆ° Anki</span>
          <span class="settings-item-value">â†“</span>
        </div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-title">å…³äº</div>
      <div class="settings-card">
        <div class="settings-item"><span class="settings-item-label">ç‰ˆæœ¬</span><span class="settings-item-value">2.0.0</span></div>
      </div>
    </div>
  </div>

  <!-- ==================== Quick Input (Collection tab only) ==================== -->
  <div class="quick-input-wrapper" id="quickInputWrapper">
    <div class="quick-input">
      <div class="quick-input-label">æ·»åŠ æ–°å†…å®¹</div>
      <input type="text" id="quickInput" placeholder="è¾“å…¥è‹±æ–‡å†…å®¹..." onkeydown="handleQuickInput(event)">
    </div>
  </div>

  <!-- ==================== Bottom Nav ==================== -->
  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item active" data-tab="collection" onclick="switchTab('collection')">
        <svg fill="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
        <span>æ”¶è—</span>
      </button>
      <button class="nav-item" data-tab="etymology" onclick="switchTab('etymology')">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
        <span>è¯æ ¹</span>
      </button>
      <button class="nav-item" data-tab="review" onclick="switchTab('review')">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5"/></svg>
        <span>å¤ä¹ </span>
      </button>
      <button class="nav-item" data-tab="settings" onclick="switchTab('settings')">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span>è®¾ç½®</span>
      </button>
    </div>
  </nav>

  <!-- ==================== Add Modal ==================== -->
  <div class="modal-overlay" id="addModal" onclick="closeAddModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-body">
        <h2 class="add-modal-title">Save to your mind</h2>
        <textarea class="add-modal-textarea" id="addInput" placeholder="ç²˜è´´æˆ–è¾“å…¥è‹±æ–‡å†…å®¹..."></textarea>
        <div class="add-modal-hint">
          <span>âœ¨ AI å°†è‡ªåŠ¨åˆ†æå¹¶æå–é‡ç‚¹è¯æ±‡</span>
        </div>
        <div class="add-modal-actions">
          <button class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="saveBtn" onclick="saveCard()"><span id="saveBtnText">ä¿å­˜</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== Detail Modal ==================== -->
  <div class="modal-overlay" id="detailModal" onclick="closeDetailModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-body" id="detailBody"></div>
    </div>
  </div>

<script>
// ======================================================================
// CONFIG & DATA
// ======================================================================
const GOOGLE_CLIENT_ID = '550666764387-5tofkeq6i4r9a8n15i50rfrgikdeinp6.apps.googleusercontent.com';
const DRIVE_FILE_NAME = 'english-collector-backup.json';

const EXPLORE_CATEGORIES = [
  { id: 'film', icon: 'ğŸ¬', name: 'å½±è§†ç¼–å‰§', color: '#f43f5e', keywords: ['screenplay','protagonist','antagonist','cinematography','montage','denouement','narrative','dialogue','subplot','exposition','climax','resolution','storyboard','voiceover','protagonist'] },
  { id: 'law', icon: 'âš–ï¸', name: 'æ³•å¾‹', color: '#8b5cf6', keywords: ['jurisdiction','litigation','plaintiff','defendant','testimony','verdict','prosecution','acquittal','statute','precedent','liability','injunction','subpoena','affidavit','deposition'] },
  { id: 'medical', icon: 'ğŸ’Š', name: 'åŒ»å­¦', color: '#10b981', keywords: ['diagnosis','prognosis','pathology','syndrome','chronic','acute','benign','malignant','inflammation','antibiotic','cardiovascular','neurological','immunology','metabolism','biopsy'] },
  { id: 'finance', icon: 'ğŸ’°', name: 'é‡‘èæŠ•èµ„', color: '#f59e0b', keywords: ['portfolio','dividend','equity','liability','liquidity','amortization','appreciation','depreciation','derivative','hedge','arbitrage','leverage','collateral','fiduciary','insolvency'] },
  { id: 'tech', icon: 'ğŸ’»', name: 'è®¡ç®—æœºç§‘æŠ€', color: '#3b82f6', keywords: ['algorithm','encryption','protocol','bandwidth','latency','synchronous','asynchronous','repository','compiler','recursion','polymorphism','virtualization','authentication','deprecated','iteration'] },
  { id: 'biology', icon: 'ğŸ§¬', name: 'ç”Ÿç‰©ç§‘å­¦', color: '#14b8a6', keywords: ['photosynthesis','mitochondria','chromosome','genome','enzyme','organism','cellular','mutation','symbiosis','metabolism','prokaryote','eukaryote','homeostasis','phylogeny','biodiversity'] },
  { id: 'psychology', icon: 'ğŸ§ ', name: 'å¿ƒç†å­¦', color: '#ec4899', keywords: ['cognition','perception','consciousness','subconscious','neurosis','psychosis','empathy','introspection','behaviorism','conditioning','reinforcement','catharsis','projection','repression','transference'] },
];

const COURSE_DATA = {
  level1: { title: 'Level 1ï¼šæ ¸å¿ƒè¯æ ¹å…¥é—¨', description: 'æŒæ¡50ä¸ªæœ€å¸¸ç”¨è¯æ ¹ï¼Œè§£é”3000+å•è¯', units: [
    { id:'u1', title:'æ•°å­—è¯æ ¹', subtitle:'uni-, bi-, tri-, cent-...', rootCount:8, wordCount:80, roots:['uni- (ä¸€)','bi- (äºŒ)','tri- (ä¸‰)','quad- (å››)','pent- (äº”)','hex- (å…­)','cent- (ç™¾)','milli- (åƒ)'], words:['universe','unique','bicycle','bilingual','triangle','tripod','quadrant','pentagon','hexagon','century','millennium'] },
    { id:'u2', title:'æ–¹å‘ä¸ä½ç½®', subtitle:'ex-, in-, pro-, re-, trans-...', rootCount:10, wordCount:120, roots:['ex- (å‡º)','in- (è¿›å…¥)','pro- (å‘å‰)','re- (è¿”å›)','trans- (ç©¿è¶Š)','sub- (ä¸‹)','super- (ä¸Š)','inter- (ä¹‹é—´)','circum- (ç¯ç»•)','pre- (å‰)'], words:['export','import','progress','return','transport','submarine','superior','international','circumstance','predict'] },
    { id:'u3', title:'åŠ¨ä½œè¯æ ¹ï¼ˆä¸Šï¼‰', subtitle:'duct-, port-, scrib-, spec-...', rootCount:8, wordCount:100, roots:['duct- (å¼•å¯¼)','port- (æºå¸¦)','scrib-/script- (å†™)','spec-/spect- (çœ‹)','aud- (å¬)','dict- (è¯´)','fac-/fact- (åš)','ject- (æŠ•æ·)'], words:['conduct','portable','describe','inspect','audience','dictate','factory','project'] },
    { id:'u4', title:'åŠ¨ä½œè¯æ ¹ï¼ˆä¸‹ï¼‰', subtitle:'vert-, mit-, cred-, struct-...', rootCount:8, wordCount:100, roots:['vert-/vers- (è½¬)','mit-/miss- (é€)','cred- (ç›¸ä¿¡)','struct- (å»ºé€ )','rupt- (ç ´)','tract- (æ‹‰)','pos-/pon- (æ”¾ç½®)','cap-/cept- (æŠ“å–)'], words:['convert','transmit','credit','construct','interrupt','attract','compose','capture'] },
    { id:'u5', title:'çŠ¶æ€ä¸æ€§è´¨', subtitle:'viv-, mort-, nov-, sens-...', rootCount:8, wordCount:80, roots:['viv- (æ´»)','mort- (æ­»)','nov- (æ–°)','sens-/sent- (æ„Ÿè§‰)','sol- (å•ç‹¬)','grat- (æ„Ÿè°¢)','liber- (è‡ªç”±)','simil- (ç›¸ä¼¼)'], words:['survive','mortal','novel','sensitive','solitary','grateful','liberty','similar'] },
  ]},
  level2: { title: 'Level 2ï¼šå¸Œè…Šè¯­ç³»è¯æ ¹', description: 'ç§‘å­¦ä¸å­¦æœ¯é¢†åŸŸçš„æ ¸å¿ƒè¯æ ¹', units: [
    { id:'u6', title:'ç§‘å­¦è¯æ ¹', subtitle:'bio-, geo-, hydro-, thermo-...', rootCount:10, wordCount:100, roots:['bio- (ç”Ÿå‘½)','geo- (åœ°çƒ)','hydro- (æ°´)','thermo- (çƒ­)','photo- (å…‰)','tele- (è¿œ)','auto- (è‡ªæˆ‘)','micro- (å°)','macro- (å¤§)','poly- (å¤š)'], words:['biology','geography','hydrogen','thermometer','photograph','telephone','automatic','microscope','macroeconomics','polygon'] },
    { id:'u7', title:'æ€ç»´ä¸çŸ¥è¯†', subtitle:'log-, soph-, phil-, psych-...', rootCount:8, wordCount:80, roots:['log-/logy (å­¦é—®)','soph- (æ™ºæ…§)','phil- (çˆ±)','psych- (å¿ƒçµ)','gno-/gnos- (çŸ¥é“)','crit- (åˆ¤æ–­)','theo- (ç¥)','arch- (ç»Ÿæ²»/å¤è€)'], words:['psychology','philosophy','technology','sophisticated','diagnosis','criticism','theology','archaeology'] },
  ]},
  level3: { title: 'Level 3ï¼šä¸“ä¸šé¢†åŸŸè¯æ ¹', description: 'æ³•å¾‹ã€åŒ»å­¦ã€å•†ä¸šé¢†åŸŸä¸“ç”¨è¯æ ¹', units: [
    { id:'u8', title:'åŒ»å­¦è¯æ ¹', subtitle:'cardio-, neuro-, derm-, path-...', rootCount:10, wordCount:100, roots:['cardio- (å¿ƒè„)','neuro- (ç¥ç»)','derm- (çš®è‚¤)','path- (ç–¾ç—…/æ„Ÿå—)','hemo- (è¡€)','osteo- (éª¨)','gastro- (èƒƒ)','hepat- (è‚)','ren- (è‚¾)','pulmo- (è‚º)'], words:['cardiology','neuroscience','dermatology','pathology','hemorrhage','osteoporosis','gastritis','hepatitis','renal','pulmonary'] },
    { id:'u9', title:'æ³•å¾‹è¯æ ¹', subtitle:'jud-, leg-, jur-, dict-...', rootCount:8, wordCount:80, roots:['jud-/judic- (åˆ¤æ–­)','leg- (æ³•å¾‹)','jur- (å®£èª“/æ³•å¾‹)','licit- (åˆæ³•)','crim- (ç½ª)','poen-/pun- (æƒ©ç½š)','test- (è§è¯)','advoc- (å£°æ´)'], words:['judicial','legal','jury','illicit','criminal','punish','testimony','advocate'] },
  ]}
};

const DAILY_ARTICLES = [
  { day:0, theme:'æ•°å­—è¯æ ¹', title:'ä»uni-åˆ°milli-: æ•°å­—å¦‚ä½•å¡‘é€ è¯­è¨€', content:'ä½ çŸ¥é“å—ï¼Ÿuniversityï¼ˆå¤§å­¦ï¼‰å’Œuniverseï¼ˆå®‡å®™ï¼‰æœ‰ç€ç›¸åŒçš„è¯æ ¹ï¼uni-æ¥è‡ªæ‹‰ä¸è¯­unusï¼Œæ„ä¸º"ä¸€"ã€‚å¤§å­¦æœ€åˆçš„å«ä¹‰æ˜¯"å¸ˆç”Ÿç»Ÿä¸€ä½“"â€”â€”æ‰€æœ‰äººunitedä¸ºä¸€ä¸ªæ•´ä½“ã€‚è€Œå®‡å®™åˆ™æ˜¯"ä¸€åˆ‡è½¬å‘åŒä¸€ä¸ªæ–¹å‘"çš„æ„æ€ã€‚\n\nåŒæ ·ï¼Œbicycleçš„bi-è¡¨ç¤º"äºŒ"ï¼ˆä¸¤ä¸ªè½®å­ï¼‰ï¼Œtriangleçš„tri-è¡¨ç¤º"ä¸‰"ï¼ˆä¸‰ä¸ªè§’ï¼‰ï¼Œè€Œcenturyæ¥è‡ªcent-è¡¨ç¤º"ä¸€ç™¾"ï¼ˆä¸€ç™¾å¹´ï¼‰ã€‚æŒæ¡è¿™äº›æ•°å­—è¯æ ¹ï¼Œä½ å°±èƒ½è½»æ¾ç†è§£å‡ ç™¾ä¸ªå•è¯ï¼', roots:['uni-','bi-','tri-','cent-'], examples:[{word:'universe',meaning:'å®‡å®™ï¼ˆä¸€ä¸ªæ•´ä½“ï¼‰'},{word:'bicycle',meaning:'è‡ªè¡Œè½¦ï¼ˆä¸¤ä¸ªè½®å­ï¼‰'}] },
  { day:1, theme:'æ–¹å‘è¯æ ¹', title:'è¿›ä¸å‡ºï¼šex-å’Œin-çš„å¥‡å¦™ä¸–ç•Œ', content:'exportå’Œimportæ˜¯ä¸€å¯¹æœ‰è¶£çš„åä¹‰è¯ã€‚ex-è¡¨ç¤º"å‡º"ï¼Œportè¡¨ç¤º"æºå¸¦"ï¼Œæ‰€ä»¥exportå°±æ˜¯"æºå¸¦å‡ºå»"=å‡ºå£ã€‚è€Œin-è¡¨ç¤º"è¿›å…¥"ï¼Œimportå°±æ˜¯"æºå¸¦è¿›æ¥"=è¿›å£ã€‚\n\nè¿™ä¸ªè§„å¾‹é€‚ç”¨äºå¾ˆå¤šè¯ï¼šexcludeï¼ˆæ’é™¤åœ¨å¤–ï¼‰vs includeï¼ˆåŒ…å«åœ¨å†…ï¼‰ï¼Œexternalï¼ˆå¤–éƒ¨çš„ï¼‰vs internalï¼ˆå†…éƒ¨çš„ï¼‰ã€‚è®°ä½è¿™äº›å‰ç¼€çš„æ–¹å‘æ„Ÿï¼Œè¯æ±‡å­¦ä¹ äº‹åŠåŠŸå€ï¼', roots:['ex-','in-','port-'], examples:[{word:'export',meaning:'å‡ºå£ï¼ˆå¸¦å‡ºå»ï¼‰'},{word:'import',meaning:'è¿›å£ï¼ˆå¸¦è¿›æ¥ï¼‰'}] },
  { day:2, theme:'ç§‘å­¦è¯æ ¹', title:'å¸Œè…Šäººçš„æ™ºæ…§ï¼šbio-, geo-, photo-', content:'biologyä¸ºä»€ä¹ˆå«ç”Ÿç‰©å­¦ï¼Ÿå› ä¸ºbio-æ¥è‡ªå¸Œè…Šè¯­biosï¼Œæ„ä¸º"ç”Ÿå‘½"ï¼Œè€Œ-logyè¡¨ç¤º"å­¦é—®"ã€‚æ‰€ä»¥biologyå°±æ˜¯"å…³äºç”Ÿå‘½çš„å­¦é—®"ã€‚\n\nåŒç†ï¼Œgeographyï¼ˆåœ°ç†å­¦ï¼‰= geo-ï¼ˆåœ°çƒï¼‰+ -graphyï¼ˆä¹¦å†™/æè¿°ï¼‰ï¼Œphotographï¼ˆç…§ç‰‡ï¼‰= photo-ï¼ˆå…‰ï¼‰+ -graphï¼ˆå†™ï¼‰ï¼Œæ˜¯"ç”¨å…‰æ¥ä¹¦å†™"ï¼Œå› ä¸ºæ—©æœŸæ‘„å½±ç¡®å®æ˜¯ç”¨å…‰åœ¨èƒ¶ç‰‡ä¸Š"å†™"ä¸‹å›¾åƒï¼', roots:['bio-','geo-','photo-','-logy'], examples:[{word:'biology',meaning:'ç”Ÿç‰©å­¦'},{word:'photograph',meaning:'ç…§ç‰‡ï¼ˆå…‰å†™ï¼‰'}] },
  { day:3, theme:'èº«ä½“è¯æ ¹', title:'ä»å¿ƒåˆ°è„‘ï¼šåŒ»å­¦è¯æ ¹çš„æ•…äº‹', content:'cardiologyï¼ˆå¿ƒè„ç—…å­¦ï¼‰çš„cardio-æ¥è‡ªå¸Œè…Šè¯­kardiaï¼Œæ„ä¸º"å¿ƒè„"ã€‚æœ‰è¶£çš„æ˜¯ï¼Œè‹±è¯­ä¸­çš„heartå’Œå¸Œè…Šè¯­kardiaå…¶å®æœ‰å…±åŒçš„å°æ¬§è¯­ç¥–å…ˆï¼\n\nneurologyï¼ˆç¥ç»ç—…å­¦ï¼‰çš„neuro-æ¥è‡ªå¸Œè…Šè¯­neuronï¼ŒåŸæ„æ˜¯"å¼¦ã€è…±"ï¼Œåæ¥å¼•ç”³ä¸º"ç¥ç»"â€”â€”å› ä¸ºç¥ç»çœ‹èµ·æ¥åƒèº«ä½“é‡Œçš„ç»†å¼¦ã€‚dermatologyï¼ˆçš®è‚¤ç§‘ï¼‰çš„derm-åˆ™æ¥è‡ªå¸Œè…Šè¯­dermaï¼Œæ„ä¸º"çš®è‚¤"ã€‚', roots:['cardio-','neuro-','derm-'], examples:[{word:'cardiology',meaning:'å¿ƒè„ç—…å­¦'},{word:'neurology',meaning:'ç¥ç»ç—…å­¦'}] },
  { day:4, theme:'åŠ¨ä½œè¯æ ¹', title:'duct, port, scribï¼šä¸‰ä¸ªä¸‡èƒ½åŠ¨è¯æ ¹', content:'duct-æ¥è‡ªæ‹‰ä¸è¯­ducereï¼Œæ„ä¸º"å¼•å¯¼ã€å¸¦é¢†"ã€‚æ‰€ä»¥conductoræ˜¯"ä¸€èµ·å¼•å¯¼çš„äºº"ï¼ˆæŒ‡æŒ¥/å”®ç¥¨å‘˜ï¼‰ï¼Œintroductionæ˜¯"å¼•å¯¼è¿›å…¥"ï¼ˆä»‹ç»/å¼•è¨€ï¼‰ã€‚\n\nport-æ¥è‡ªæ‹‰ä¸è¯­portareï¼Œæ„ä¸º"æºå¸¦"ã€‚portableæ˜¯"å¯æºå¸¦çš„"ï¼Œtransportæ˜¯"è·¨è¶Šæºå¸¦"=è¿è¾“ã€‚\n\nscrib-/script-æ¥è‡ªæ‹‰ä¸è¯­scribereï¼Œæ„ä¸º"å†™"ã€‚describeæ˜¯"å‘ä¸‹å†™"=æè¿°ï¼Œmanuscriptæ˜¯"æ‰‹å†™çš„"=æ‰‹ç¨¿ã€‚', roots:['duct-','port-','scrib-'], examples:[{word:'conduct',meaning:'å¼•å¯¼ã€æŒ‡æŒ¥'},{word:'describe',meaning:'æè¿°ï¼ˆå‘ä¸‹å†™ï¼‰'}] },
  { day:5, theme:'æ€ç»´è¯æ ¹', title:'phil-å’Œsoph-ï¼šçˆ±ä¸æ™ºæ…§', content:'philosophyæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿphil-æ¥è‡ªå¸Œè…Šè¯­philosï¼Œæ„ä¸º"çˆ±"ï¼Œsoph-æ¥è‡ªsophiaï¼Œæ„ä¸º"æ™ºæ…§"ã€‚æ‰€ä»¥philosophyå°±æ˜¯"çˆ±æ™ºæ…§"â€”â€”å¯¹æ™ºæ…§çš„çƒ­çˆ±ä¸è¿½æ±‚ã€‚\n\nphilanthropyï¼ˆæ…ˆå–„ï¼‰= phil-ï¼ˆçˆ±ï¼‰+ anthrop-ï¼ˆäººç±»ï¼‰ï¼Œçˆ±äººç±»ã€‚\nsophisticatedï¼ˆå¤æ‚ç²¾å¯†çš„ï¼‰åŸæœ¬æŒ‡"åƒæ™ºè€…ä¸€æ ·"ï¼Œåæ¥å¼•ç”³ä¸º"è€ç»ƒçš„ã€ç²¾å¯†çš„"ã€‚', roots:['phil-','soph-','anthrop-'], examples:[{word:'philosophy',meaning:'å“²å­¦ï¼ˆçˆ±æ™ºæ…§ï¼‰'},{word:'philanthropy',meaning:'æ…ˆå–„ï¼ˆçˆ±äººç±»ï¼‰'}] },
  { day:6, theme:'ç”Ÿæ­»è¯æ ¹', title:'viv-å’Œmort-ï¼šç”Ÿä¸æ­»çš„è¯­è¨€å¯†ç ', content:'surviveä¸ºä»€ä¹ˆè¡¨ç¤º"å¹¸å­˜"ï¼Ÿsur-è¡¨ç¤º"è¶…è¶Š"ï¼Œviv-æ¥è‡ªæ‹‰ä¸è¯­vivereï¼Œæ„ä¸º"æ´»"ã€‚æ‰€ä»¥surviveå°±æ˜¯"è¶…è¶Šäº†æ­»äº¡ç»§ç»­æ´»ç€"=å¹¸å­˜ã€‚vividï¼ˆç”ŸåŠ¨çš„ï¼‰ä¹Ÿæ¥è‡ªåŒä¸€è¯æ ¹â€”â€”å……æ»¡ç”Ÿå‘½åŠ›çš„ã€‚\n\nç›¸åï¼Œmort-æ¥è‡ªæ‹‰ä¸è¯­mors/mortisï¼Œæ„ä¸º"æ­»äº¡"ã€‚mortalæ˜¯"ä¼šæ­»çš„"ï¼ˆå‡¡äººï¼‰ï¼Œimmortalæ˜¯"ä¸æ­»çš„"ï¼ˆç¥ä»™ï¼‰ã€‚mortgageï¼ˆæŠµæŠ¼è´·æ¬¾ï¼‰å­—é¢æ„æ€æ˜¯"æ­»äº¡æ‰¿è¯º"â€”â€”è¦ä¹ˆè¿˜æ¸…è´·æ¬¾ï¼Œè¦ä¹ˆå¤±å»è´¢äº§ï¼', roots:['viv-','mort-','sur-'], examples:[{word:'survive',meaning:'å¹¸å­˜ï¼ˆè¶…è¶Šæ­»äº¡ï¼‰'},{word:'mortal',meaning:'å‡¡äººï¼ˆä¼šæ­»çš„ï¼‰'}] },
];

// ======================================================================
// STATE
// ======================================================================
let cards = [];
let etymologyWords = []; // saved from etymology analysis
let settings = { apiProvider:'gemini', apiModel:'gemini-2.5-flash', apiKey:'', firstUseDate:null, autoSync:false };
let reviewState = { words:[], currentIndex:0, results:[] };
let reviewRecords = {}; // wordKey -> { wordKey, word, level, nextReview, reviewCount, correctCount, wrongCount, lastReview }
const REVIEW_INTERVALS = [0, 1, 3, 7, 15, 30]; // days per level (0=new, 1-5=spaced)
let googleUser = null, accessToken = null;
let etyAnalysis = null, etyLoading = false;
let currentEtyView = 'search';
let currentCourseLevel = 'level1', currentCourseUnit = null;

// ======================================================================
// IndexedDB
// ======================================================================
const DB_NAME = 'EnglishCollectorDB';
let db;

async function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 3);
    req.onerror = (e) => { console.error('DB open error:', e); reject(req.error); };
    req.onsuccess = () => { db = req.result; console.log('DB opened, version:', db.version); resolve(db); };
    req.onblocked = () => {
      console.warn('DB upgrade blocked - trying without upgrade');
      showToast('æ•°æ®åº“å‡çº§ä¸­ï¼Œè¯·å…³é—­å…¶ä»–æ ‡ç­¾é¡µååˆ·æ–°', 'error');
      // Try opening without version upgrade as fallback
      const fallback = indexedDB.open(DB_NAME);
      fallback.onsuccess = () => { db = fallback.result; console.log('DB fallback opened, version:', db.version); resolve(db); };
      fallback.onerror = () => reject(fallback.error);
    };
    req.onupgradeneeded = (e) => {
      const d = e.target.result;
      console.log('DB upgrading from v' + e.oldVersion + ' to v' + e.newVersion);
      if (!d.objectStoreNames.contains('cards')) d.createObjectStore('cards', { keyPath: 'id' });
      if (!d.objectStoreNames.contains('settings')) d.createObjectStore('settings', { keyPath: 'key' });
      if (!d.objectStoreNames.contains('etymologyWords')) d.createObjectStore('etymologyWords', { keyPath: 'word' });
      if (!d.objectStoreNames.contains('reviewRecords')) d.createObjectStore('reviewRecords', { keyPath: 'wordKey' });
    };
  });
}

function ensureDB() { if (!db) throw new Error('æ•°æ®åº“æœªå°±ç»ªï¼Œè¯·åˆ·æ–°é¡µé¢'); }

async function dbGetAll(store) {
  ensureDB();
  return new Promise((r, e) => { const q = db.transaction([store],'readonly').objectStore(store).getAll(); q.onsuccess = () => r(q.result||[]); q.onerror = () => e(q.error); });
}
async function dbGet(store, key) {
  ensureDB();
  return new Promise((r, e) => { const q = db.transaction([store],'readonly').objectStore(store).get(key); q.onsuccess = () => r(q.result); q.onerror = () => e(q.error); });
}
async function dbPut(store, data) {
  ensureDB();
  return new Promise((r, e) => { const q = db.transaction([store],'readwrite').objectStore(store).put(data); q.onsuccess = () => r(); q.onerror = () => e(q.error); });
}
async function dbDelete(store, key) {
  ensureDB();
  return new Promise((r, e) => { const q = db.transaction([store],'readwrite').objectStore(store).delete(key); q.onsuccess = () => r(); q.onerror = () => e(q.error); });
}

async function loadData() {
  const hasStore = (name) => db.objectStoreNames.contains(name);
  
  cards = hasStore('cards') ? await dbGetAll('cards') : [];
  cards.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
  etymologyWords = hasStore('etymologyWords') ? await dbGetAll('etymologyWords') : [];
  // Load review records into memory map
  reviewRecords = {};
  if (hasStore('reviewRecords')) {
    const recs = await dbGetAll('reviewRecords');
    recs.forEach(r => { reviewRecords[r.wordKey] = r; });
  }
  const saved = hasStore('settings') ? await dbGet('settings', 'main') : null;
  if (saved) settings = { ...settings, ...saved.value };
  document.getElementById('apiProvider').value = settings.apiProvider;
  document.getElementById('apiKey').value = settings.apiKey;
  document.getElementById('autoSyncToggle').checked = settings.autoSync;
  updateModelOptions();
  console.log('Data loaded: cards='+cards.length+', etymWords='+etymologyWords.length+', reviews='+Object.keys(reviewRecords).length);
}

async function saveCardToDB(card) {
  await dbPut('cards', card);
  const idx = cards.findIndex(c => c.id === card.id);
  if (idx >= 0) cards[idx] = card; else cards.unshift(card);
}
async function deleteCardFromDB(cardId) {
  await dbDelete('cards', cardId);
  cards = cards.filter(c => c.id !== cardId);
}
async function saveEtyWord(wordData) {
  await dbPut('etymologyWords', wordData);
  const idx = etymologyWords.findIndex(w => w.word === wordData.word);
  if (idx >= 0) etymologyWords[idx] = wordData; else etymologyWords.push(wordData);
}
async function deleteEtyWord(word) {
  await dbDelete('etymologyWords', word);
  etymologyWords = etymologyWords.filter(w => w.word !== word);
}
async function saveSettingsToDB() {
  await dbPut('settings', { key:'main', value: settings });
}

// ======================================================================
// SIDEBAR & AUTH
// ======================================================================
function openSidebar() { document.getElementById('sidebar').classList.add('active'); document.getElementById('sidebarOverlay').classList.add('active'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebarOverlay').classList.remove('active'); }

function handleGoogleAuth() {
  if (googleUser) {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) { googleUser=null; accessToken=null; localStorage.removeItem('ec_access_token'); localStorage.removeItem('ec_user'); updateUserUI(); showToast('å·²é€€å‡ºç™»å½•','success'); }
    return;
  }
  const client = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
    callback: async (response) => { if (response.access_token) { accessToken = response.access_token; localStorage.setItem('ec_access_token', accessToken); await fetchUserInfo(); if (settings.autoSync) await syncFromCloud(); } },
  });
  client.requestAccessToken();
}

async function fetchUserInfo() {
  try {
    const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { 'Authorization': `Bearer ${accessToken}` } });
    if (!res.ok) throw new Error('Token expired');
    googleUser = await res.json();
    localStorage.setItem('ec_user', JSON.stringify(googleUser));
    updateUserUI(); showToast('ç™»å½•æˆåŠŸï¼','success');
  } catch(e) { accessToken=null; localStorage.removeItem('ec_access_token'); localStorage.removeItem('ec_user'); updateUserUI(); }
}

function updateUserUI() {
  const avatar=document.getElementById('userAvatar'), name=document.getElementById('userName'), email=document.getElementById('userEmail');
  const dot=document.getElementById('syncDot'), text=document.getElementById('syncStatusText');
  if (googleUser) {
    avatar.innerHTML = googleUser.picture ? `<img src="${googleUser.picture}" alt="">` : '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>';
    name.textContent = googleUser.name||'ç”¨æˆ·'; email.textContent = googleUser.email||''; dot.classList.add('synced'); text.textContent = 'å·²è¿æ¥ Google';
  } else {
    avatar.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>';
    name.textContent = 'æœªç™»å½•'; email.textContent = 'ç‚¹å‡»ç™»å½• Google åŒæ­¥'; dot.classList.remove('synced'); text.textContent = 'æœ¬åœ°å­˜å‚¨';
  }
}

// ======================================================================
// GOOGLE DRIVE SYNC
// ======================================================================
async function findDriveFile() {
  const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}' and trashed=false&fields=files(id,name)`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
  if (!res.ok) throw new Error('Failed to search files');
  const data = await res.json();
  return data.files?.length > 0 ? data.files[0].id : null;
}

async function syncToCloud() {
  if (!accessToken) { showToast('è¯·å…ˆç™»å½• Google','error'); return false; }
  const freshCards = await dbGetAll('cards');
  const freshEtyWords = await dbGetAll('etymologyWords');
  const freshReviewRecs = await dbGetAll('reviewRecords');
  if (freshCards.length === 0 && freshEtyWords.length === 0) { showToast('æœ¬åœ°æ²¡æœ‰æ•°æ®','error'); return false; }
  const dot=document.getElementById('syncDot'), text=document.getElementById('syncStatusText');
  dot.classList.remove('synced'); dot.classList.add('syncing'); text.textContent = 'åŒæ­¥ä¸­...';
  try {
    const payload = JSON.stringify({ version:'2.1.0', syncDate:new Date().toISOString(), cards:freshCards, etymologyWords:freshEtyWords, reviewRecords:freshReviewRecs, settings:{...settings, apiKey:''} });
    let fileId = await findDriveFile();
    let res;
    if (fileId) {
      res = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, { method:'PATCH', headers:{ 'Authorization':`Bearer ${accessToken}`, 'Content-Type':'application/json' }, body:payload });
    } else {
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify({ name:DRIVE_FILE_NAME, mimeType:'application/json' })], { type:'application/json' }));
      form.append('file', new Blob([payload], { type:'application/json' }));
      res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method:'POST', headers:{ 'Authorization':`Bearer ${accessToken}` }, body:form });
    }
    if (!res.ok) throw new Error('Upload failed');
    cards = freshCards; etymologyWords = freshEtyWords;
    dot.classList.remove('syncing'); dot.classList.add('synced'); text.textContent = 'å·²åŒæ­¥';
    showToast(`å·²åŒæ­¥ ${freshCards.length} æ¡æ”¶è— + ${freshEtyWords.length} ä¸ªè¯æ±‡`, 'success');
    return true;
  } catch(e) { dot.classList.remove('syncing'); text.textContent = 'åŒæ­¥å¤±è´¥'; showToast('åŒæ­¥å¤±è´¥: '+e.message,'error'); return false; }
}

async function syncFromCloud() {
  if (!accessToken) { showToast('è¯·å…ˆç™»å½• Google','error'); return; }
  try {
    showToast('æ­£åœ¨ä»äº‘ç«¯è·å–...','');
    const fileId = await findDriveFile();
    if (!fileId) { showToast('äº‘ç«¯æ²¡æœ‰å¤‡ä»½','error'); return; }
    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers:{ 'Authorization':`Bearer ${accessToken}` } });
    if (!res.ok) throw new Error('ä¸‹è½½å¤±è´¥');
    const data = await res.json();
    // Merge cards
    if (data.cards?.length) {
      const map = new Map(cards.map(c=>[c.id,c]));
      data.cards.forEach(c => { const ex=map.get(c.id); if(!ex||new Date(c.createdAt)>new Date(ex.createdAt)) map.set(c.id,c); });
      for (const card of map.values()) await saveCardToDB(card);
      cards = Array.from(map.values()).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    }
    // Merge etymology words
    if (data.etymologyWords?.length) {
      for (const w of data.etymologyWords) await saveEtyWord(w);
    }
    // Merge review records
    if (data.reviewRecords?.length) {
      for (const r of data.reviewRecords) {
        const existing = reviewRecords[r.wordKey];
        if (!existing || r.reviewCount > existing.reviewCount) {
          reviewRecords[r.wordKey] = r;
          await dbPut('reviewRecords', r);
        }
      }
    }
    renderCards(); updateStats();
    showToast(`å·²æ¢å¤ ${cards.length} æ¡æ”¶è—`, 'success');
  } catch(e) { showToast('æ¢å¤å¤±è´¥: '+e.message,'error'); }
}

async function manualSync() {
  if (!accessToken) { showToast('è¯·å…ˆç™»å½• Google','error'); return; }
  closeSidebar();
  const localCards = await dbGetAll('cards');
  if (localCards.length > 0) await syncToCloud(); else { showToast('æœ¬åœ°æ— æ•°æ®ï¼Œå°è¯•æ¢å¤...',''); await syncFromCloud(); }
}

function toggleAutoSync() { settings.autoSync = document.getElementById('autoSyncToggle').checked; saveSettingsToDB(); showToast(settings.autoSync?'å·²å¼€å¯è‡ªåŠ¨åŒæ­¥':'å·²å…³é—­è‡ªåŠ¨åŒæ­¥','success'); }

// ======================================================================
// SPEECH
// ======================================================================
function speakWord(word) {
  if (!word) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(word); u.lang='en-US'; u.rate=0.8;
  const v = window.speechSynthesis.getVoices().find(v=>v.lang.startsWith('en'));
  if (v) u.voice = v;
  window.speechSynthesis.speak(u);
}

// ======================================================================
// TAB SWITCHING
// ======================================================================
function switchTab(tab) {
  document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.tab===tab));
  document.getElementById('tabCollection').classList.toggle('active', tab==='collection');
  document.getElementById('tabEtymology').classList.toggle('active', tab==='etymology');
  document.getElementById('tabReview').classList.toggle('active', tab==='review');
  document.getElementById('tabSettings').classList.toggle('active', tab==='settings');
  // Show header & quick input only for collection
  document.getElementById('mainHeader').classList.toggle('hide', tab!=='collection');
  document.getElementById('quickInputWrapper').classList.toggle('hide', tab!=='collection');
  if (tab==='review') initReview();
  if (tab==='settings') updateStats();
  if (tab==='etymology') renderEtyView();
}

// ======================================================================
// COLLECTION (TAB 1)
// ======================================================================
function renderCards() {
  const grid = document.getElementById('cardGrid');
  const empty = document.getElementById('emptyState');
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = cards.filter(c =>
    c.content.toLowerCase().includes(query) || c.translation?.toLowerCase().includes(query) || c.keywords?.some(k=>k.word.toLowerCase().includes(query))
  );
  if (filtered.length===0) { grid.innerHTML=''; empty.classList.remove('hide'); return; }
  empty.classList.add('hide');
  grid.innerHTML = filtered.map(card => `
    <div class="card" onclick="openDetailModal('${card.id}')">
      <div class="card-content">${esc(card.content)}</div>
      ${card.keywords?.length ? `<div class="card-keywords">${card.keywords.slice(0,3).map(k=>`<span class="keyword-tag">${esc(k.word)}</span>`).join('')}</div>` : ''}
    </div>`).join('');
}

function openDetailModal(cardId) {
  const card = cards.find(c=>c.id===cardId);
  if (!card) return;
  const tc = card.type==='word'?'type-word':card.type==='sentence'?'type-sentence':'type-paragraph';
  const tl = card.type==='word'?'è¯':card.type==='sentence'?'å¥':'æ®µ';
  const date = new Date(card.createdAt).toLocaleDateString('zh-CN');
  let kwHtml = '';
  if (card.keywords?.length) {
    kwHtml = `<div class="keywords-section"><div class="keywords-title"><div class="keywords-title-bar"></div><span class="keywords-title-text">é‡ç‚¹è¯æ±‡</span></div>
      <div class="keywords-list">${card.keywords.map((k,i)=>`<button class="keyword-btn ${i===0?'active':''}" onclick="showKeywordEtymology('${cardId}',${i})">${esc(k.word)}</button>`).join('')}</div></div>
      <div class="etymology-box" id="etymologyBox">${renderKwEtymology(card.keywords[0])}</div>`;
  }
  document.getElementById('detailBody').innerHTML = `
    <div class="detail-header"><div class="detail-meta"><span class="type-dot ${tc}"></span><span class="detail-date">${tl} Â· ${date}</span></div>
      <button class="modal-close" onclick="closeDetailModal()"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button></div>
    <p class="detail-content">${esc(card.content)}</p>
    <p class="detail-translation">${esc(card.translation||'')}</p>
    ${kwHtml}
    <div class="add-modal-actions">
      <button class="btn btn-secondary" onclick="deleteCard('${cardId}')">åˆ é™¤</button>
      <button class="btn btn-primary" onclick="exportSingleAnki('${cardId}')">å¯¼å‡º Anki</button>
    </div>`;
  document.getElementById('detailModal').classList.add('active');
}

function renderKwEtymology(kw) {
  if (!kw) return '';
  return `<div class="etymology-header"><div class="etymology-word">${esc(kw.word)}</div>
    <button class="speak-btn" onclick="speakWord('${esc(kw.word)}')">ğŸ”Š</button></div>
    ${kw.phonetic?`<div class="etymology-phonetic">${esc(kw.phonetic)}</div>`:''}
    <div class="etymology-item"><span class="etymology-label">æ„è¯ Â· </span><span class="etymology-value">${esc(kw.roots||'-')}</span></div>
    <div class="etymology-item"><span class="etymology-label">æ¥æº Â· </span><span class="etymology-value">${esc(kw.origin||'-')}</span></div>
    <div class="etymology-item"><span class="etymology-label">é‡Šä¹‰ Â· </span><span class="etymology-value">${esc(kw.meaning||'-')}</span></div>`;
}

function showKeywordEtymology(cardId, idx) {
  const card = cards.find(c=>c.id===cardId);
  if (!card?.keywords) return;
  document.querySelectorAll('.keyword-btn').forEach((b,i)=>b.classList.toggle('active',i===idx));
  document.getElementById('etymologyBox').innerHTML = renderKwEtymology(card.keywords[idx]);
}

function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); }
function openAddModal() { document.getElementById('addModal').classList.add('active'); document.getElementById('addInput').focus(); }
function closeAddModal() { document.getElementById('addModal').classList.remove('active'); document.getElementById('addInput').value=''; }

async function saveCard() {
  const content = document.getElementById('addInput').value.trim();
  if (!content) return;
  if (!settings.apiKey) { showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key','error'); return; }
  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  document.getElementById('saveBtnText').innerHTML = '<div class="spinner"></div>';
  try {
    const analysis = await callAI(buildCollectionPrompt(content));
    const wc = content.split(/\s+/).length;
    const type = wc<=3?'word':content.split(/[.!?]/).filter(s=>s.trim()).length<=1?'sentence':'paragraph';
    const card = { id:'card_'+Date.now(), content, type, translation:analysis.translation, keywords:analysis.keywords, createdAt:new Date().toISOString() };
    await saveCardToDB(card);
    if (!settings.firstUseDate) { settings.firstUseDate = new Date().toISOString(); await saveSettingsToDB(); }
    renderCards(); updateStats(); closeAddModal(); showToast('ä¿å­˜æˆåŠŸï¼','success');
    if (settings.autoSync && accessToken) syncToCloud();
  } catch(e) { showToast('ä¿å­˜å¤±è´¥: '+e.message,'error'); }
  finally { btn.disabled=false; document.getElementById('saveBtnText').textContent='ä¿å­˜'; }
}

async function deleteCard(cardId) {
  if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
  await deleteCardFromDB(cardId); renderCards(); updateStats(); closeDetailModal(); showToast('å·²åˆ é™¤','success');
  if (settings.autoSync && accessToken) syncToCloud();
}

function handleQuickInput(e) {
  if (e.key==='Enter') {
    const c = document.getElementById('quickInput').value.trim();
    if (c) { document.getElementById('addInput').value=c; document.getElementById('quickInput').value=''; openAddModal(); saveCard(); }
  }
}
function handleSearch() { renderCards(); }

// ======================================================================
// ETYMOLOGY TAB (TAB 2)
// ======================================================================
function switchEtyView(view) {
  currentEtyView = view;
  document.querySelectorAll('.ety-sub-btn').forEach(b=>b.classList.toggle('active',b.dataset.view===view));
  document.getElementById('etySearchView').classList.toggle('hide',view!=='search');
  document.getElementById('etyExploreView').classList.toggle('hide',view!=='explore');
  document.getElementById('etyCourseView').classList.toggle('hide',view!=='course');
  renderEtyView();
}

function renderEtyView() {
  if (currentEtyView==='search') renderEtySearchView();
  else if (currentEtyView==='explore') renderEtyExploreView();
  else if (currentEtyView==='course') renderEtyCourseView();
}

// --- Search View ---
function renderEtySearchView() {
  const el = document.getElementById('etySearchView');
  if (etyAnalysis) { renderEtyResult(el); return; }
  
  // Search history
  const history = JSON.parse(localStorage.getItem('ety_search_history') || '[]');
  const historyHtml = history.length > 0 ? `
    <div style="margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:12px;color:var(--text-muted)">æœ€è¿‘æœç´¢</span>
        <span style="font-size:11px;color:var(--accent);background:var(--accent-light);padding:2px 8px;border-radius:10px">å·²ç¼“å­˜ ${etymologyWords.length} è¯</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        ${history.slice(0, 10).map(w => {
          const isCached = etymologyWords.some(ew => ew.word.toLowerCase() === w.toLowerCase());
          return `<button onclick="etySearchWord('${esc(w)}')" style="padding:6px 12px;font-size:12px;background:${isCached ? 'var(--accent-light)' : 'white'};color:${isCached ? 'var(--accent)' : 'var(--text-secondary)'};border:1px solid ${isCached ? 'rgba(232,97,44,0.2)' : 'var(--border)'};border-radius:16px;cursor:pointer">${esc(w)} ${isCached ? 'âœ“' : ''}</button>`;
        }).join('')}
      </div>
    </div>` : '';
  
  // Daily article
  const article = DAILY_ARTICLES[new Date().getDay()];
  el.innerHTML = historyHtml + `
    <div class="daily-article">
      <div class="article-badge">ğŸ“… ä»Šæ—¥è¯æº Â· ${article.theme}</div>
      <h3 class="article-title">${article.title}</h3>
      <p class="article-content">${article.content}</p>
      <div class="article-roots">${article.roots.map(r=>`<span class="article-root-tag">${r}</span>`).join('')}</div>
      <div class="article-examples">${article.examples.map(ex=>`<button class="article-word-btn" onclick="etySearchWord('${ex.word}')"><span class="article-word-text">${ex.word}</span><span class="article-word-meaning">${ex.meaning}</span></button>`).join('')}</div>
    </div>`;
}

function renderEtyResult(el) {
  const a = etyAnalysis;
  const isCached = etymologyWords.some(w=>w.word===a.word);
  el.innerHTML = `
    <div class="ety-result">
      <div class="ety-result-header">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <span class="ety-result-word">${esc(a.word)}</span>
          <button class="speak-btn" onclick="speakWord('${esc(a.word)}')">ğŸ”Š</button>
          ${isCached ? '<span style="font-size:11px;padding:3px 8px;background:rgba(76,175,80,0.1);color:var(--success);border-radius:10px">âœ“ å·²ç¼“å­˜</span>' : ''}
        </div>
        <p class="ety-result-phonetic">${esc(a.phonetic||'')}</p>
        <p class="ety-result-meaning">${esc(a.meaning||'')}</p>
        <div class="ety-result-actions">
          <button class="btn btn-secondary btn-small" onclick="etyAnalysis=null;renderEtySearchView()">â† è¿”å›</button>
          <button class="btn btn-secondary btn-small" onclick="removeEtyCache('${esc(a.word)}')">æ¸…é™¤ç¼“å­˜</button>
        </div>
      </div>
      ${a.roots?.length?`<div class="ety-card"><div class="ety-card-title"><span>ğŸ§¬</span> è¯æ ¹æ‹†è§£</div>
        ${a.roots.map(r=>`<div class="ety-root-item"><span class="ety-root-part">${esc(r.part)}</span><button class="speak-btn" style="width:28px;height:28px;font-size:12px" onclick="speakWord('${esc(r.part.replace(/[-]/g,''))}')">ğŸ”Š</button><span class="ety-root-origin">${esc(r.origin)}</span><span class="ety-root-meaning">â†’ ${esc(r.meaning)}</span></div>`).join('')}</div>`:''}
      ${a.etymology_story?`<div class="ety-card"><div class="ety-card-title"><span>ğŸ“–</span> è¯æºæ•…äº‹</div><p class="ety-story">${esc(a.etymology_story)}</p>${a.memory_tip?`<div class="ety-memory-tip">ğŸ’¡ ${esc(a.memory_tip)}</div>`:''}</div>`:''}
      ${a.examples?.length?`<div class="ety-card"><div class="ety-card-title"><span>ğŸ“</span> ä¾‹å¥</div>
        ${a.examples.map(ex=>`<div class="ety-example"><div class="ety-example-en"><button class="speak-btn" style="width:24px;height:24px;font-size:11px;flex-shrink:0" onclick="speakWord(\`${esc(ex.sentence)}\`)">ğŸ”Š</button>${esc(ex.sentence)}</div><div class="ety-example-cn">${esc(ex.translation)}</div></div>`).join('')}</div>`:''}
      ${a.related_words?.length?`<div class="ety-related"><span style="font-size:13px;color:var(--text-muted)">ç›¸å…³è¯æ±‡ï¼š</span>${a.related_words.map(w=>`<button class="ety-related-tag" onclick="etySearchWord('${esc(w)}')">${esc(w)}</button>`).join('')}</div>`:''}
    </div>`;
}

async function removeEtyCache(word) {
  await deleteEtyWord(word);
  etyAnalysis = null;
  renderEtySearchView();
  showToast('å·²æ¸…é™¤ç¼“å­˜','success');
}

async function etySearch() {
  const word = document.getElementById('etySearchInput').value.trim();
  if (!word) return;
  etySearchWord(word);
}

async function etySearchWord(word) {
  if (!settings.apiKey) { showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key','error'); return; }
  document.getElementById('etySearchInput').value = word;
  switchEtyView('search');

  // 1. Check cache first
  const cached = etymologyWords.find(w => w.word.toLowerCase() === word.toLowerCase());
  if (cached) {
    etyAnalysis = cached;
    renderEtyResult(document.getElementById('etySearchView'));
    showToast('ä»ç¼“å­˜åŠ è½½ âœ“','success');
    updateEtySearchHistory(word);
    return;
  }

  // 2. Call API
  etyAnalysis = null;
  const el = document.getElementById('etySearchView');
  el.innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner spinner-dark" style="width:28px;height:28px;border-width:3px"></div><p style="margin-top:12px;color:var(--text-muted);font-size:14px">æ­£åœ¨åˆ†æ ' + esc(word) + ' ...</p></div>';
  const btn = document.getElementById('etySearchBtn');
  btn.disabled = true;
  try {
    const result = await callAI(buildEtymologyPrompt(word));
    etyAnalysis = result;
    // 3. Auto-save to cache
    await saveEtyWord({ ...result, savedAt: Date.now() });
    updateEtySearchHistory(word);
    renderEtyResult(el);
    showToast('å·²è‡ªåŠ¨ç¼“å­˜','success');
  } catch(e) {
    el.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ˜¥</div><p class="empty-state-desc">åˆ†æå¤±è´¥: ${esc(e.message)}</p></div>`;
  }
  btn.disabled = false;
}

function updateEtySearchHistory(word) {
  let history = JSON.parse(localStorage.getItem('ety_search_history') || '[]');
  history = [word, ...history.filter(w => w.toLowerCase() !== word.toLowerCase())].slice(0, 15);
  localStorage.setItem('ety_search_history', JSON.stringify(history));
}

async function saveEtyWordFromAnalysis() {
  if (!etyAnalysis) return;
  if (!etymologyWords.some(w => w.word === etyAnalysis.word)) {
    await saveEtyWord({ ...etyAnalysis, savedAt:Date.now() });
    showToast('å·²æ”¶è—åˆ°è¯åº“','success');
  }
  renderEtySearchView();
}

// --- Explore View ---
function renderEtyExploreView() {
  const el = document.getElementById('etyExploreView');
  el.innerHTML = `
    <h3 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px">æŒ‰é¢†åŸŸæ¢ç´¢ä¸“ä¸šè¯æ±‡</h3>
    <div class="cat-grid">${EXPLORE_CATEGORIES.map(c=>{
      const cached = c.keywords.filter(w => etymologyWords.some(ew => ew.word.toLowerCase() === w.toLowerCase())).length;
      return `<div class="cat-card" onclick="showCategoryWords('${c.id}')">
        <div class="cat-icon">${c.icon}</div>
        <div class="cat-name">${c.name}</div>
        <div class="cat-count">${cached}/${c.keywords.length} å·²å­¦</div>
        ${cached>0?`<div style="width:100%;height:3px;background:var(--warm-gray);border-radius:2px;margin-top:4px"><div style="width:${Math.round(cached/c.keywords.length*100)}%;height:100%;background:var(--accent);border-radius:2px"></div></div>`:''}
      </div>`;
    }).join('')}
    </div>
    <div id="categoryWordList"></div>`;
}

function showCategoryWords(catId) {
  const cat = EXPLORE_CATEGORIES.find(c=>c.id===catId);
  if (!cat) return;
  const cachedCount = cat.keywords.filter(w => etymologyWords.some(ew => ew.word.toLowerCase() === w.toLowerCase())).length;
  document.getElementById('categoryWordList').innerHTML = `
    <h3 style="font-size:16px;font-weight:600;color:var(--text-primary);margin:16px 0 8px">${cat.icon} ${cat.name}</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">å·²å­¦ä¹  ${cachedCount}/${cat.keywords.length} è¯</p>
    <div class="word-list">${cat.keywords.map(w=>{
      const isCached = etymologyWords.some(ew => ew.word.toLowerCase() === w.toLowerCase());
      return `<div class="word-list-item" style="${isCached?'background:rgba(76,175,80,0.05)':''}"><span style="flex:1;cursor:pointer" onclick="etySearchWord('${w}')">${w} ${isCached?'<span style=font-size:10px;color:var(--success)>âœ“</span>':''}</span><button class="speak-btn" style="width:28px;height:28px;font-size:12px;flex-shrink:0" onclick="event.stopPropagation();speakWord('${w}')">ğŸ”Š</button><span style="cursor:pointer;color:var(--text-muted)" onclick="etySearchWord('${w}')">â†’</span></div>`;
    }).join('')}
    </div>`;
}

// --- Course View ---
function renderEtyCourseView() {
  const el = document.getElementById('etyCourseView');
  if (currentCourseUnit) { renderCourseUnit(el); return; }
  el.innerHTML = `
    <h3 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:16px">ç³»ç»Ÿè¯¾ç¨‹ Â· ç›®æ ‡æŒæ¡10000è¯</h3>
    <div class="level-tabs">${Object.keys(COURSE_DATA).map(l=>`<button class="level-tab ${currentCourseLevel===l?'active':''}" onclick="currentCourseLevel='${l}';renderEtyCourseView()">${COURSE_DATA[l].title.split('ï¼š')[0]}</button>`).join('')}</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">${COURSE_DATA[currentCourseLevel].description}</p>
    <div class="unit-grid">${COURSE_DATA[currentCourseLevel].units.map((u,i)=>`
      <div class="unit-card">
        <div class="unit-header"><span class="unit-number">Unit ${i+1}</span></div>
        <div class="unit-title">${u.title}</div>
        <div class="unit-subtitle">${u.subtitle}</div>
        <div class="unit-stats"><span>${u.rootCount} è¯æ ¹</span><span>${u.wordCount}+ å•è¯</span></div>
        <div class="unit-actions">
          <button class="btn btn-primary btn-small" onclick="currentCourseUnit=COURSE_DATA['${currentCourseLevel}'].units[${i}];renderEtyCourseView()">å­¦ä¹ </button>
        </div>
      </div>`).join('')}</div>`;
}

function renderCourseUnit(el) {
  const u = currentCourseUnit;
  const cachedCount = u.words.filter(w => etymologyWords.some(ew => ew.word.toLowerCase() === w.toLowerCase())).length;
  el.innerHTML = `
    <button class="btn btn-secondary btn-small" onclick="currentCourseUnit=null;renderEtyCourseView()" style="margin-bottom:16px">â† è¿”å›è¯¾ç¨‹</button>
    <h3 style="font-size:20px;font-weight:600;color:var(--text-primary);margin-bottom:4px">${u.title}</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">å·²å­¦ä¹  ${cachedCount}/${u.words.length} è¯</p>
    <div class="ety-card"><div class="ety-card-title">ğŸ“Œ æ ¸å¿ƒè¯æ ¹</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px">${u.roots.map(r=>`<span class="article-root-tag" style="cursor:pointer" onclick="speakWord('${r.split('(')[0].replace(/[-\s]/g,'')}')">${r} ğŸ”Š</span>`).join('')}</div></div>
    <div class="ety-card"><div class="ety-card-title">ğŸ“ ä¾‹è¯åˆ—è¡¨</div>
      <div class="word-list">${u.words.map(w=>{
        const isCached = etymologyWords.some(ew => ew.word.toLowerCase() === w.toLowerCase());
        return `<div class="word-list-item" style="${isCached?'background:rgba(76,175,80,0.05)':''}"><span style="flex:1;cursor:pointer" onclick="etySearchWord('${w}')">${w} ${isCached?'<span style=font-size:10px;color:var(--success)>âœ“</span>':''}</span><button class="speak-btn" style="width:28px;height:28px;font-size:12px;flex-shrink:0" onclick="event.stopPropagation();speakWord('${w}')">ğŸ”Š</button><span style="cursor:pointer;color:var(--text-muted)" onclick="etySearchWord('${w}')">â†’</span></div>`;
      }).join('')}</div></div>`;
}

// ======================================================================
// REVIEW TAB (TAB 3) - Spaced Repetition System
// ======================================================================
// Intervals: Level 0=new, 1=1day, 2=3days, 3=7days, 4=15days, 5=30days(mastered)

function getAllReviewableWords() {
  const wordMap = new Map();
  cards.forEach(card => card.keywords?.forEach(kw => {
    const key = kw.word.toLowerCase();
    if (!wordMap.has(key)) wordMap.set(key, { word:kw.word, phonetic:kw.phonetic, meaning:kw.meaning, roots:kw.roots, origin:kw.origin, example:card.content, source:'collection' });
  }));
  etymologyWords.forEach(ew => {
    const key = ew.word.toLowerCase();
    if (!wordMap.has(key)) wordMap.set(key, { word:ew.word, phonetic:ew.phonetic, meaning:ew.meaning, roots:ew.roots?.map(r=>r.part+' â†’ '+r.meaning).join(', '), origin:ew.etymology_story||'', example:ew.examples?.[0]?.sentence||'', source:'etymology' });
  });
  return wordMap;
}

function updateReviewStats() {
  const wordMap = getAllReviewableWords();
  const now = Date.now();
  let dueCount = 0, newCount = 0, masteredCount = 0;
  wordMap.forEach((_, key) => {
    const rec = reviewRecords[key];
    if (!rec) { newCount++; }
    else if (rec.level >= 5) { masteredCount++; }
    else if (rec.nextReview <= now) { dueCount++; }
  });
  document.getElementById('reviewDueCount').textContent = dueCount;
  document.getElementById('reviewNewCount').textContent = newCount;
  document.getElementById('reviewMasteredCount').textContent = masteredCount;
  document.getElementById('reviewTotalCount').textContent = wordMap.size;
}

function initReview() {
  document.getElementById('reviewSummary').classList.add('hide');
  document.getElementById('reviewHistoryPanel').classList.add('hide');
  const wordMap = getAllReviewableWords();
  const now = Date.now();
  
  // Categorize words
  const dueWords = [], newWords = [], allWords = [];
  wordMap.forEach((data, key) => {
    const rec = reviewRecords[key];
    const item = { ...data, wordKey: key };
    allWords.push(item);
    if (!rec) { newWords.push(item); }
    else if (rec.level < 5 && rec.nextReview <= now) { dueWords.push(item); }
  });
  
  // Priority: due words first, then some new words, max 20
  let sessionWords = [];
  // Shuffle due words and take all
  dueWords.sort(() => Math.random() - 0.5);
  sessionWords.push(...dueWords);
  // Fill remaining slots with new words
  const remaining = Math.max(0, 20 - sessionWords.length);
  newWords.sort(() => Math.random() - 0.5);
  sessionWords.push(...newWords.slice(0, remaining));
  // Cap at 20
  sessionWords = sessionWords.slice(0, 20);
  
  if (sessionWords.length === 0 && allWords.length > 0) {
    // No due words, show review-complete message
    document.getElementById('reviewContent').classList.add('hide');
    document.getElementById('reviewEmpty').classList.add('hide');
    document.getElementById('reviewSummary').classList.remove('hide');
    document.getElementById('summaryEmoji').textContent = 'âœ…';
    document.getElementById('summaryTitle').textContent = 'ä»Šæ—¥å¤ä¹ å·²å®Œæˆ';
    document.getElementById('summaryText').textContent = `æ‰€æœ‰å¾…å¤ä¹ çš„è¯æ±‡éƒ½å·²å¤ä¹ å®Œæ¯•ã€‚æ–°è¯ ${newWords.length > 0 ? 'ä¹Ÿæ²¡æœ‰äº†' : 'ä¼šåœ¨æ”¶è—åè‡ªåŠ¨åŠ å…¥'}ã€‚`;
    updateReviewStats();
    return;
  }
  
  if (sessionWords.length === 0) {
    document.getElementById('reviewContent').classList.add('hide');
    document.getElementById('reviewEmpty').classList.remove('hide');
    updateReviewStats();
    return;
  }
  
  document.getElementById('reviewContent').classList.remove('hide');
  document.getElementById('reviewEmpty').classList.add('hide');
  reviewState.words = sessionWords;
  reviewState.currentIndex = 0;
  reviewState.results = [];
  showCurrentWord();
  updateReviewStats();
}

function showCurrentWord() {
  const w = reviewState.words[reviewState.currentIndex];
  if (!w) return;
  const rec = reviewRecords[w.wordKey];
  const levelLabel = rec ? `Lv.${rec.level}` : 'æ–°è¯';
  document.getElementById('reviewProgress').textContent = `${reviewState.currentIndex+1} / ${reviewState.words.length}ã€€${levelLabel}`;
  document.getElementById('flashcardWord').textContent = w.word;
  document.getElementById('flashcardPhonetic').textContent = w.phonetic||'';
  document.getElementById('flashcardBack').innerHTML = `
    <div class="flashcard-back-word">${esc(w.word)}</div>
    <div class="flashcard-back-meaning">${esc(w.meaning||'')}</div>
    <div class="flashcard-back-detail"><span>æ„è¯:</span> ${esc(w.roots||'-')}<br><span>æ¥æº:</span> ${esc(w.origin||'-')}<br><span>ä¾‹å¥:</span> ${esc(w.example||'')}</div>`;
  document.getElementById('flashcard').classList.remove('flipped');
}

function flipCard() { document.getElementById('flashcard').classList.toggle('flipped'); }

async function markCard(known) {
  const w = reviewState.words[reviewState.currentIndex];
  if (!w) return;
  
  // Update review record
  const now = Date.now();
  let rec = reviewRecords[w.wordKey] || { wordKey: w.wordKey, word: w.word, level: 0, nextReview: now, reviewCount: 0, correctCount: 0, wrongCount: 0, lastReview: 0 };
  
  rec.reviewCount++;
  rec.lastReview = now;
  
  if (known) {
    rec.correctCount++;
    rec.level = Math.min(5, rec.level + 1);
  } else {
    rec.wrongCount++;
    rec.level = Math.max(1, Math.min(rec.level, 1)); // Reset to level 1 on wrong
  }
  
  // Calculate next review time based on new level
  const intervalDays = REVIEW_INTERVALS[rec.level] || 1;
  rec.nextReview = now + intervalDays * 86400000;
  
  // Save to IndexedDB and memory
  reviewRecords[w.wordKey] = rec;
  await dbPut('reviewRecords', rec);
  
  // Track result
  reviewState.results.push({ word: w.word, known, newLevel: rec.level });
  reviewState.currentIndex++;
  
  if (reviewState.currentIndex >= reviewState.words.length) {
    // Session complete - show summary
    const correctCount = reviewState.results.filter(r => r.known).length;
    const total = reviewState.results.length;
    
    document.getElementById('reviewContent').classList.add('hide');
    document.getElementById('reviewSummary').classList.remove('hide');
    
    const ratio = correctCount / total;
    document.getElementById('summaryEmoji').textContent = ratio >= 0.8 ? 'ğŸ‰' : ratio >= 0.5 ? 'ğŸ‘' : 'ğŸ’ª';
    document.getElementById('summaryTitle').textContent = ratio >= 0.8 ? 'å¤ªæ£’äº†ï¼' : ratio >= 0.5 ? 'ç»§ç»­åŠ æ²¹ï¼' : 'å†ç»ƒç»ƒå°±å¥½äº†ï¼';
    document.getElementById('summaryText').textContent = `æœ¬æ¬¡å¤ä¹  ${total} è¯ï¼Œè®¤è¯† ${correctCount} ä¸ªï¼Œæ­£ç¡®ç‡ ${Math.round(ratio*100)}%`;
    
    updateReviewStats();
  } else {
    showCurrentWord();
  }
}

function showReviewHistory() {
  document.getElementById('reviewSummary').classList.add('hide');
  document.getElementById('reviewContent').classList.add('hide');
  document.getElementById('reviewStats').style.display = 'none';
  document.getElementById('reviewHistoryPanel').classList.remove('hide');
  
  const levelNames = ['æ–°è¯', 'åˆå­¦ (1å¤©)', 'ç†Ÿæ‚‰ (3å¤©)', 'ç†è§£ (7å¤©)', 'å·©å›º (15å¤©)', 'å·²æŒæ¡ âœ“'];
  const entries = Object.values(reviewRecords).sort((a,b) => b.lastReview - a.lastReview);
  
  if (entries.length === 0) {
    document.getElementById('reviewHistoryList').innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:40px 0">è¿˜æ²¡æœ‰å¤ä¹ è®°å½•</p>';
    return;
  }
  
  document.getElementById('reviewHistoryList').innerHTML = entries.map(r => `
    <div class="review-history-item">
      <span class="review-history-word">${esc(r.word)}</span>
      <button class="speak-btn" style="width:28px;height:28px;font-size:12px" onclick="speakWord('${esc(r.word)}')">ğŸ”Š</button>
      <span class="review-level-badge review-level-${r.level}">${levelNames[r.level]||'Lv.'+r.level}</span>
      <span style="font-size:11px;color:var(--text-muted)">${r.correctCount}âœ“ ${r.wrongCount}âœ—</span>
    </div>`).join('');
}

function closeReviewHistory() {
  document.getElementById('reviewHistoryPanel').classList.add('hide');
  document.getElementById('reviewStats').style.display = '';
  initReview();
}

// ======================================================================
// SETTINGS (TAB 4)
// ======================================================================
function onProviderChange() {
  settings.apiProvider = document.getElementById('apiProvider').value;
  updateModelOptions();
  saveSettings();
}

function saveSettings() {
  settings.apiProvider = document.getElementById('apiProvider').value;
  settings.apiModel = document.getElementById('apiModel').value;
  settings.apiKey = document.getElementById('apiKey').value;
  saveSettingsToDB();
}

function updateModelOptions() {
  const models = {
    gemini: [{ v:'gemini-2.5-flash', l:'Gemini 2.5 Flash' }, { v:'gemini-2.0-flash', l:'Gemini 2.0 Flash' }],
    openrouter: [{ v:'anthropic/claude-sonnet-4', l:'Claude Sonnet 4' }, { v:'anthropic/claude-haiku-4.5', l:'Claude Haiku 4.5ï¼ˆä¾¿å®œï¼‰' }],
    deepseek: [{ v:'deepseek-chat', l:'DeepSeek Chat' }]
  };
  const sel = document.getElementById('apiModel');
  const opts = models[settings.apiProvider]||[];
  sel.innerHTML = opts.map(m=>`<option value="${m.v}">${m.l}</option>`).join('');
  // Try to restore saved model
  if (opts.some(m=>m.v===settings.apiModel)) sel.value = settings.apiModel;
  else if (opts.length) { settings.apiModel = opts[0].v; sel.value = settings.apiModel; }
}

function updateStats() {
  document.getElementById('statTotal').textContent = cards.length;
  const words = new Set();
  cards.forEach(c=>c.keywords?.forEach(k=>words.add(k.word.toLowerCase())));
  etymologyWords.forEach(w=>words.add(w.word.toLowerCase()));
  document.getElementById('statWords').textContent = words.size;
  document.getElementById('statEtyCount').textContent = etymologyWords.length;
  if (settings.firstUseDate) document.getElementById('statDays').textContent = Math.ceil((new Date()-new Date(settings.firstUseDate))/86400000);
}

// ======================================================================
// AI API
// ======================================================================
function buildCollectionPrompt(content) {
  return `åˆ†æä»¥ä¸‹è‹±æ–‡å†…å®¹ï¼Œè¿”å›JSONæ ¼å¼ï¼ˆä¸è¦markdownä»£ç å—ï¼‰ï¼š

å†…å®¹ï¼š"${content}"

è¦æ±‚ï¼š
1. translation: ä¸­æ–‡ç¿»è¯‘
2. keywords: æ•°ç»„ï¼Œæœ€å¤š5ä¸ªé‡ç‚¹è¯æ±‡ï¼ˆä¸è¦é€‰ the, is, a ç­‰ç®€å•è¯ï¼‰ï¼Œæ¯ä¸ªåŒ…å«ï¼š
   - word: å•è¯
   - phonetic: éŸ³æ ‡
   - roots: è¯æ ¹æ„æˆ
   - origin: è¯æº
   - meaning: ä¸­æ–‡é‡Šä¹‰

è¿”å›æ ¼å¼ï¼š{"translation":"...","keywords":[{"word":"...","phonetic":"...","roots":"...","origin":"...","meaning":"..."}]}`;
}

function buildEtymologyPrompt(word) {
  return `ä½œä¸ºè¯æºå­¦ä¸“å®¶ï¼Œè¯·åˆ†æå•è¯ "${word}" çš„è¯æ ¹è¯æºã€‚è¯·ç”¨ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼ˆä¸è¦markdownä»£ç å—ï¼Œç›´æ¥è¿”å›JSONï¼‰ï¼š
{
  "word": "å•è¯",
  "phonetic": "éŸ³æ ‡",
  "meaning": "æ ¸å¿ƒå«ä¹‰ï¼ˆç®€æ´ä¸­æ–‡ï¼‰",
  "roots": [
    { "part": "è¯æ ¹/è¯ç¼€éƒ¨åˆ†", "origin": "æ¥æºè¯­è¨€", "originalWord": "åŸå§‹è¯", "meaning": "è¯¥éƒ¨åˆ†å«ä¹‰" }
  ],
  "etymology_story": "ç”¨ç”ŸåŠ¨æœ‰è¶£çš„æ–¹å¼è®²è§£è¿™ä¸ªè¯çš„æ¥æºæ•…äº‹ï¼Œ150å­—ä»¥å†…",
  "memory_tip": "ä¸€å¥è¯è®°å¿†æŠ€å·§",
  "examples": [
    { "sentence": "è‹±æ–‡ä¾‹å¥", "translation": "ä¸­æ–‡ç¿»è¯‘" },
    { "sentence": "è‹±æ–‡ä¾‹å¥2", "translation": "ä¸­æ–‡ç¿»è¯‘2" }
  ],
  "related_words": ["ç›¸å…³è¯1", "ç›¸å…³è¯2", "ç›¸å…³è¯3"]
}`;
}

async function callAI(prompt) {
  const res = await fetch('/api/analyze', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ provider:settings.apiProvider, model:settings.apiModel, apiKey:settings.apiKey, prompt })
  });
  if (!res.ok) { const e = await res.json(); throw new Error(e.message || 'API failed'); }
  return await res.json();
}

// ======================================================================
// EXPORT / IMPORT
// ======================================================================
function exportJSON() {
  const allReviewRecs = Object.values(reviewRecords);
  downloadFile(JSON.stringify({ version:'2.1.0', exportDate:new Date().toISOString(), cards, etymologyWords, reviewRecords:allReviewRecs, settings:{...settings,apiKey:''} }, null, 2), 'english-collector-backup.json', 'application/json');
  showToast('å¤‡ä»½å·²å¯¼å‡º','success');
}

function importJSON(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.cards?.length) for (const c of data.cards) await saveCardToDB(c);
      if (data.etymologyWords?.length) for (const w of data.etymologyWords) await saveEtyWord(w);
      cards = await dbGetAll('cards'); cards.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
      etymologyWords = await dbGetAll('etymologyWords');
      renderCards(); updateStats();
      showToast(`å·²å¯¼å…¥ ${data.cards?.length||0} æ¡æ”¶è— + ${data.etymologyWords?.length||0} ä¸ªè¯æ±‡`,'success');
    } catch(err) { showToast('å¯¼å…¥å¤±è´¥: '+err.message,'error'); }
  };
  reader.readAsText(file); event.target.value='';
}

function exportAnki() {
  const exported = new Set(); let csv = '';
  cards.forEach(c=>c.keywords?.forEach(k=>{
    if (!exported.has(k.word.toLowerCase())) { exported.add(k.word.toLowerCase()); csv += `${escCSV(k.word)}\t${escCSV(`${k.phonetic||''}\n${k.meaning}\nè¯æ ¹: ${k.roots||'-'}\næ¥æº: ${k.origin||'-'}\nä¾‹å¥: ${c.content}`)}\n`; }
  }));
  etymologyWords.forEach(w=>{
    if (!exported.has(w.word.toLowerCase())) { exported.add(w.word.toLowerCase()); csv += `${escCSV(w.word)}\t${escCSV(`${w.phonetic||''}\n${w.meaning}\n${w.memory_tip||''}`)}\n`; }
  });
  if (!csv) { showToast('æ²¡æœ‰å†…å®¹','error'); return; }
  downloadFile(csv, `anki-words-${Date.now()}.txt`, 'text/plain');
  showToast('å·²å¯¼å‡º','success');
}

function exportSingleAnki(cardId) {
  const card = cards.find(c=>c.id===cardId); if (!card) return;
  let csv = '';
  card.keywords?.forEach(k=>{ csv += `${escCSV(k.word)}\t${escCSV(`${k.phonetic||''}\n${k.meaning}\nè¯æ ¹: ${k.roots||'-'}\næ¥æº: ${k.origin||'-'}\nä¾‹å¥: ${card.content}`)}\n`; });
  downloadFile(csv, `anki-${Date.now()}.txt`, 'text/plain');
  showToast('å·²å¯¼å‡º','success');
}

// ======================================================================
// URL IMPORT (from Chrome extension)
// ======================================================================
async function checkUrlImport() {
  const params = new URLSearchParams(window.location.search);
  const importData = params.get('import');
  if (importData) {
    try {
      const card = JSON.parse(decodeURIComponent(atob(importData)));
      await saveCardToDB(card);
      if (!settings.firstUseDate) { settings.firstUseDate=new Date().toISOString(); await saveSettingsToDB(); }
      window.history.replaceState({}, '', location.pathname);
      renderCards(); updateStats(); showToast('å·²å¯¼å…¥ï¼','success');
      if (settings.autoSync && accessToken) syncToCloud();
    } catch(e) { console.error('Import error:', e); }
  }
}

// ======================================================================
// UTILS
// ======================================================================
function showToast(msg, type='') {
  const t = document.getElementById('toast'); t.textContent=msg; t.className='toast '+type; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3000);
}
function esc(text) { if (!text) return ''; const d=document.createElement('div'); d.textContent=text; return d.innerHTML; }
function escCSV(text) { return (text||'').replace(/"/g,'""').replace(/\n/g,'<br>'); }
function downloadFile(content, filename, type) {
  const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=filename; a.click();
}

// ======================================================================
// INIT
// ======================================================================
async function init() {
  try {
    window.speechSynthesis.getVoices();
    try {
      await initDB();
    } catch(dbErr) {
      console.error('DB init failed, retrying...', dbErr);
      // If blocked, try deleting and recreating
      await new Promise(r => setTimeout(r, 1000));
      try { await initDB(); } catch(e2) {
        console.error('DB retry failed:', e2);
        showToast('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·å…³é—­å…¶ä»–æ ‡ç­¾é¡µååˆ·æ–°', 'error');
        return;
      }
    }
    await loadData();
    // Restore Google session
    const savedToken = localStorage.getItem('ec_access_token');
    const savedUser = localStorage.getItem('ec_user');
    if (savedToken && savedUser) { accessToken=savedToken; googleUser=JSON.parse(savedUser); updateUserUI(); fetchUserInfo(); }
    await checkUrlImport();
    renderCards(); updateStats();
    if (settings.autoSync && accessToken && cards.length > 0) setTimeout(()=>syncToCloud(), 2000);
  } catch(e) { console.error('Init error:', e); showToast('åˆå§‹åŒ–å¤±è´¥: '+e.message,'error'); }
}
init();
</script>
</body>
</html>
